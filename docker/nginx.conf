# GWI POS Reverse Proxy
# Routes HTTP to Next.js and WebSocket to standalone ws-server
#
# Architecture:
#   nginx (:80) -> gwi-pos (:3000) for pages/API
#   nginx (:80) -> gwi-ws  (:3001) for Socket.io + internal emit

upstream nextjs {
    server gwi-pos:3000;
    keepalive 64;
}

upstream websocket {
    server gwi-ws:3001;
    keepalive 64;
}

# Connection upgrade map for WebSocket
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    server_name _;

    # ---- WebSocket connections (Socket.io) ----
    location /ws {
        proxy_pass http://websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Socket.io needs long-lived connections
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Disable buffering for real-time
        proxy_buffering off;
        proxy_cache off;
    }

    # ---- Internal IPC (Next.js -> ws-server) ----
    location /internal/ {
        proxy_pass http://websocket;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Internal only - block external access
        # In production, use firewall rules or Docker network isolation
        # For NUC deployment, this is safe (local network only)
    }

    # ---- ws-server health check ----
    location /ws-health {
        proxy_pass http://websocket/health;
    }

    # ---- Everything else -> Next.js ----
    location / {
        proxy_pass http://nextjs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection '';

        # Enable keepalive to Next.js
        proxy_set_header X-Request-Start $msec;

        # Reasonable timeouts for API routes
        proxy_read_timeout 30s;
        proxy_send_timeout 30s;

        # Static assets can be cached
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://nextjs;
            proxy_cache_valid 200 1h;
            add_header Cache-Control "public, max-age=3600";
        }
    }

    # ---- Gzip compression ----
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 4;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml;
    gzip_min_length 256;

    # ---- Security headers ----
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # ---- Logging ----
    access_log /var/log/nginx/gwi-pos-access.log;
    error_log /var/log/nginx/gwi-pos-error.log;
}
