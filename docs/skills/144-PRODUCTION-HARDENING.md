# Skill 144: Production Hardening Pass

## Status: DONE
## Date: Feb 6, 2026
## Domain: Menu (applies to Frontend + API)
## Dependencies: 142, 143

## Overview

Comprehensive code-review-driven hardening pass to make the Menu Builder production-ready. Addressed 15 specific findings from a team code review covering safety, validation, error handling, and UX quality.

## Workers

| Worker | Task | Files | Status |
|--------|------|-------|--------|
| W13-A | Frontend quality hardening | ItemEditor.tsx, ModifierFlowEditor.tsx, page.tsx | DONE |
| W13-B | API route hardening | 3 API route files | DONE |

## Frontend Fixes (W13-A)

### 1. Cycle-Safe Recursion
**Problem:** `findGroupById()` and `findModifierById()` had no cycle detection. Circular data could cause infinite loops.

**Fix:** Added `visited: Set<string>` parameter to both functions. If an ID repeats, recursion stops immediately.

```typescript
const findGroupById = (id: string, groups?: ModifierGroup[], visited?: Set<string>): ModifierGroup | undefined => {
  const seen = visited || new Set<string>()
  for (const g of searchGroups) {
    if (seen.has(g.id)) continue  // Cycle detection
    seen.add(g.id)
    // ... recursive search
  }
}
```

### 2. Max Recursion Depth Guard
**Problem:** `renderChildGroup()` could recurse infinitely with corrupted data.

**Fix:** Added `depth > 10` guard that renders error message instead of recursing further.

### 3. Toast Notifications on All Error Handlers
**Problem:** 26 catch blocks across 3 files only did `console.error()` — users saw no feedback on failures.

**Fix:** Added `toast.error()` to all 26 catch blocks:
- 13 in ItemEditor.tsx
- 5 in ModifierFlowEditor.tsx
- 8 in page.tsx

### 4. Debounced Save (Replaced setTimeout)
**Problem:** `setTimeout(saveChanges, 100)` in ModifierFlowEditor caused race conditions — rapid toggles fired overlapping saves.

**Fix:** Replaced all 9 instances with `debouncedSave()` using `useRef` + `clearTimeout` pattern with 300ms debounce.

### 5. Price Coercion Safety
**Problem:** `parseFloat(value) || 0` collapses `null` (inherit) and `0` (explicit free) into same value.

**Fix:**
- Changed `|| 0` to `?? 0` in `startEditModifier`
- Changed to `Number.isFinite()` validation in `commitEditModifier` and `addModifier`

### 6. Static Tailwind Indentation
**Problem:** Dynamic `` ml-${depth * 4} `` not generated by Tailwind JIT compiler — child groups had no indentation.

**Fix:** Static mapping:
```typescript
const depthIndent: Record<number, string> = {
  0: 'ml-0', 1: 'ml-4', 2: 'ml-8', 3: 'ml-12', 4: 'ml-16'
}
```

### 7. Number Input Attributes
**Fix:** Added `min="0"` and `step="0.01"` to all price inputs, `step="1"` to count inputs.

### 8. Settings Disabled During __new__ Mode
**Fix:** Tiered pricing and min/max inputs disabled while creating new exclusion key. Warning message shown.

## API Fixes (W13-B)

### 1. POST Validation
- `name` required unless duplicating from existing group
- `price` and `extraPrice` validated as finite numbers

### 2. PUT Validation
- `name` cannot be empty string
- `minSelections` must be >= 0
- `maxSelections` must be >= 1

### 3. PATCH Validation
- `sortOrders` array validated: non-empty, each entry has valid `id` and finite numeric `sortOrder`

### 4. Consistent Response Shapes
- PUT now returns full nested `childModifierGroup` with all modifier fields
- Deep copy response includes `ingredientName` and nested child groups
- POST and PUT `/modifiers` return identical field shapes

## Verification Results

| Check | Result |
|-------|--------|
| `setTimeout(saveChanges)` remaining | 0 |
| `debouncedSave()` calls | 10 |
| `toast.error` in ItemEditor | 17 |
| Dynamic `ml-${depth}` remaining | 0 |
| `Number.isFinite()` validations | 3 |
| Cycle-safe `visited` Set | 4 references |
| TypeScript errors in modified files | 0 |

## Key Files

| File | Changes |
|------|---------|
| `src/components/menu/ItemEditor.tsx` | Cycle safety, toast errors, price validation, Tailwind fix, depth guard |
| `src/components/menu/ModifierFlowEditor.tsx` | Debounced save, toast errors, input validation, __new__ guard |
| `src/app/(admin)/menu/page.tsx` | Toast errors, success toasts |
| `src/app/api/menu/items/[id]/modifier-groups/route.ts` | POST validation, PATCH validation, deep copy response |
| `src/app/api/menu/items/[id]/modifier-groups/[groupId]/route.ts` | PUT validation, full response shape |
| `src/app/api/menu/items/[id]/modifier-groups/[groupId]/modifiers/route.ts` | POST/PUT validation, consistent response |

## Code Review Findings NOT Fixed (Deferred)

| Finding | Reason |
|---------|--------|
| Route handler `params` as Promise | NOT a bug — Next.js 15+ requires `await params` |
| State management / shared context | Architectural — Phase 2 |
| Type consolidation to index.ts | Tech debt — separate pass |
| Cross-item ingredient ID remapping | Low risk in single-location |
| Drag-drop visual constraints | Cosmetic — future pass |
| Ingredient defaults centralization | Waiting on new workflow |

## Related Skills
- 142: Tiered Pricing (what was hardened)
- 143: Item-Owned Groups (what was hardened)
- 145: Ingredient Verification System (added during this pass)
