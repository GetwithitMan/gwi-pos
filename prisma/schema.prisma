// GWI POS Database Schema
// Version: 1.0.0
// Based on Skills Documentation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ORGANIZATION & LOCATIONS (Skill 53)
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations Location[]
}

model Location {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  name     String
  slug     String?  @unique // URL-friendly identifier for venue subdomains
  address  String?
  phone    String?
  timezone String  @default("America/New_York")
  isActive Boolean @default(true)

  // Settings
  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employees             Employee[]
  roles                 Role[]
  categories            Category[]
  menuItems             MenuItem[]
  modifierGroups        ModifierGroup[]
  orderTypes            OrderType[]
  orders                Order[]
  tables                Table[]
  sections              Section[]
  drawers               Drawer[]
  shifts                Shift[]
  timeClock             TimeClockEntry[]
  discountRules         DiscountRule[]
  prepStations          PrepStation[]
  customers             Customer[]
  giftCards             GiftCard[]
  houseAccounts         HouseAccount[]
  coupons               Coupon[]
  reservations          Reservation[]
  entertainmentWaitlist EntertainmentWaitlist[]
  floorPlanElements     FloorPlanElement[]
  // Seat-Level Ticketing
  seats   Seat[]
  events  Event[]
  tickets Ticket[]

  // Liquor Builder (Skill: Liquor)
  spiritCategories   SpiritCategory[]
  bottleProducts     BottleProduct[]
  spiritUpsellEvents SpiritUpsellEvent[]

  // Tip Sharing
  tipOutRules    TipOutRule[]
  tipShares      TipShare[]
  tipPools       TipPool[]
  tipPoolEntries TipPoolEntry[]

  // Tip Bank Ledger (Skill 250)
  tipLedgers        TipLedger[]
  tipLedgerEntries  TipLedgerEntry[]
  tipTransactions   TipTransaction[]

  // Tip Groups (Skill 252)
  tipGroupTemplates      TipGroupTemplate[]
  tipGroups              TipGroup[]
  tipGroupMemberships    TipGroupMembership[]
  tipGroupSegments       TipGroupSegment[]
  orderOwnerships        OrderOwnership[]

  // Tip Adjustments & Compliance (Skills 256, 259)
  tipAdjustments         TipAdjustment[]
  cashTipDeclarations    CashTipDeclaration[]

  // Tip Debt (Skill 278 - Chargeback Remainder)
  tipDebts               TipDebt[]

  // Order Details (multi-tenancy)
  orderItems         OrderItem[]
  orderItemModifiers OrderItemModifier[]
  orderDiscounts     OrderDiscount[]
  payments           Payment[]

  // Menu Details (multi-tenancy)
  modifiers              Modifier[]
  menuItemModifierGroups MenuItemModifierGroup[]

  // Combos (multi-tenancy)
  comboTemplates        ComboTemplate[]
  comboComponents       ComboComponent[]
  comboComponentOptions ComboComponentOption[]

  // Multi-role support (multi-tenancy)
  employeeRoles        EmployeeRole[]

  // Operations (multi-tenancy)
  paidInOuts           PaidInOut[]
  sectionAssignments   SectionAssignment[]
  voidLogs             VoidLog[]
  refundLogs           RefundLog[]
  breaks               Break[]
  remoteVoidApprovals  RemoteVoidApproval[]

  // Transactions (multi-tenancy)
  couponRedemptions        CouponRedemption[]
  giftCardTransactions     GiftCardTransaction[]
  houseAccountTransactions HouseAccountTransaction[]

  // Events (multi-tenancy)
  eventPricingTiers EventPricingTier[]
  eventTableConfigs EventTableConfig[]
  upsellEvents      UpsellEvent[]
  upsellConfigs     UpsellConfig[]

  // Inventory & Tax (multi-tenancy)
  taxRules              TaxRule[]
  inventoryTransactions InventoryTransaction[]
  stockAlerts           StockAlert[]

  // Inventory & Recipe Costing (Skill 115)
  voidReasons               VoidReason[]
  storageLocations          StorageLocation[]
  inventoryItems            InventoryItem[]
  inventoryItemStorages     InventoryItemStorage[]
  prepItems                 PrepItem[]
  prepItemIngredients       PrepItemIngredient[]
  menuItemRecipes           MenuItemRecipe[]
  menuItemRecipeIngredients MenuItemRecipeIngredient[]
  modifierInventoryLinks    ModifierInventoryLink[]
  inventoryCounts           InventoryCount[]
  inventoryCountItems       InventoryCountItem[]
  inventoryItemTransactions InventoryItemTransaction[]
  vendors                   Vendor[]
  invoices                  Invoice[]
  invoiceLineItems          InvoiceLineItem[]
  wasteLogEntries           WasteLogEntry[]
  inventorySettings         InventorySettings?

  // Liquor Builder (multi-tenancy)
  recipeIngredients    RecipeIngredient[]
  spiritModifierGroups SpiritModifierGroup[]

  // Menu Item Ingredients (multi-tenancy)
  ingredientCategories    IngredientCategory[]
  ingredientSwapGroups    IngredientSwapGroup[]
  ingredients             Ingredient[]
  ingredientRecipes       IngredientRecipe[]
  menuItemIngredients     MenuItemIngredient[]
  orderItemIngredients    OrderItemIngredient[]

  // Modifier Group Templates (for quick item-specific group creation)
  modifierGroupTemplates ModifierGroupTemplate[]

  // Hardware Management
  printers          Printer[]
  kdsScreens        KDSScreen[]
  kdsScreenStations KDSScreenStation[]
  stations          Station[]
  terminals         Terminal[]
  printRules        PrintRule[]
  printRoutes       PrintRoute[]
  printJobs         PrintJob[]
  paymentReaders    PaymentReader[]
  readerLogs        PaymentReaderLog[]

  // Order Cards (multi-card tabs)
  orderCards OrderCard[]

  // Datacap Advanced Features (Sprint 3)
  digitalReceipts  DigitalReceipt[]
  chargebackCases  ChargebackCase[]
  cardProfiles     CardProfile[]
  walkoutRetries   WalkoutRetry[]

  // Sync Audit
  syncAuditEntries SyncAuditEntry[]

  // Pizza Builder
  pizzaConfigs     PizzaConfig[]
  pizzaSizes       PizzaSize[]
  pizzaCrusts      PizzaCrust[]
  pizzaSauces      PizzaSauce[]
  pizzaCheeses     PizzaCheese[]
  pizzaToppings    PizzaTopping[]
  pizzaSpecialties PizzaSpecialty[]
  orderItemPizzas  OrderItemPizza[]

  // Payroll & Scheduling
  payrollPeriods      PayrollPeriod[]
  payStubs            PayStub[]
  schedules           Schedule[]
  scheduledShifts     ScheduledShift[]
  availabilityEntries AvailabilityEntry[]
  shiftSwapRequests   ShiftSwapRequest[]
  payrollSettings     PayrollSettings?

  // Course Configuration
  courseConfigs CourseConfig[]

  // Daily Prep Counting
  prepTrayConfigs              PrepTrayConfig[]
  dailyPrepCounts              DailyPrepCount[]
  dailyPrepCountItems          DailyPrepCountItem[]
  dailyPrepCountTransactions   DailyPrepCountTransaction[]
  ingredientStockAdjustments   IngredientStockAdjustment[]

  // Bottle Service (Phase 10)
  bottleServiceTiers BottleServiceTier[]

  // Error Reporting (Domain 16)
  errorLogs       ErrorLog[]
  performanceLogs PerformanceLog[]
  healthChecks    HealthCheck[]

  // Fleet Management (Skill 345)
  serverRegistrationTokens ServerRegistrationToken[]

  // Item-level discounts (P2-D01)
  itemDiscounts OrderItemDiscount[]

  // Mobile Device Authentication (P2-E02)
  registeredDevices RegisteredDevice[]
  mobileSessions    MobileSession[]

  @@index([organizationId])
}

// ============================================
// CUSTOMERS (Skill 51)
// ============================================

model Customer {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Basic info
  firstName   String
  lastName    String
  displayName String? // Optional nickname
  email       String?
  phone       String?

  // Preferences
  notes String? // Allergies, preferences, etc.
  tags  Json? // VIP, Regular, etc.

  // Loyalty (Skill 52 foundation)
  loyaltyPoints Int       @default(0)
  totalSpent    Decimal   @default(0)
  totalOrders   Int       @default(0)
  averageTicket Decimal   @default(0)
  lastVisit     DateTime?

  // Marketing
  marketingOptIn Boolean   @default(false)
  birthday       DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  orders        Order[]
  houseAccounts HouseAccount[]
  reservations  Reservation[]
  tickets       Ticket[]

  @@unique([locationId, email])
  @@unique([locationId, phone])
  @@index([locationId])
  @@index([lastName, firstName])
  @@index([locationId, isActive, deletedAt])
}

// ============================================
// EMPLOYEES & ROLES (Skill 05)
// ============================================

model Role {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // Server, Bartender, Manager, Admin
  permissions Json? // Array of permission strings

  // Tip configuration
  isTipped  Boolean @default(false) // Is this a tipped position?
  tipWeight Decimal @default(1.0)   // Weight for role-weighted tip group splits (e.g., 1.5 for lead bartender)

  // Cash handling configuration
  cashHandlingMode String  @default("drawer") // "drawer" | "purse" | "none"
  trackLaborCost   Boolean @default(true)      // Include hours in labor cost reports

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  employees     Employee[]
  employeeRoles EmployeeRole[]

  // Tip-out rules (role gives/receives tip-outs)
  tipOutRulesFrom TipOutRule[] @relation("TipOutFrom")
  tipOutRulesTo   TipOutRule[] @relation("TipOutTo")

  // Working-as relations (multi-role support)
  workingTimeClockEntries TimeClockEntry[] @relation("WorkingRole")
  workingShifts           Shift[]          @relation("ShiftWorkingRole")

  // Scheduled shifts for this role
  scheduledShifts ScheduledShift[]

  @@unique([locationId, name])
  @@index([locationId])
}

model Employee {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  roleId     String
  role       Role     @relation(fields: [roleId], references: [id])

  // Identity
  firstName   String
  lastName    String
  displayName String?
  email       String?
  phone       String?

  // Address (for tax documents like W-2)
  address  String?
  city     String?
  state    String?
  zipCode  String?

  // Authentication
  pin      String // 4-6 digit PIN (hashed)
  password String? // Optional password for admin access (hashed)

  // Employment
  hourlyRate Decimal?
  hireDate   DateTime @default(now())
  isActive   Boolean  @default(true)

  // Tax Information (W-4 data)
  federalFilingStatus          String?  // 'single' | 'married' | 'head_of_household'
  federalAllowances            Int      @default(0)
  additionalFederalWithholding Decimal  @default(0)
  stateFilingStatus            String?  // State-specific filing status
  stateAllowances              Int      @default(0)
  additionalStateWithholding   Decimal  @default(0)
  isExemptFromFederalTax       Boolean  @default(false)
  isExemptFromStateTax         Boolean  @default(false)

  // Payment Preferences
  paymentMethod     String? // 'direct_deposit' | 'check' | 'cash'
  bankName          String?
  bankRoutingNumber String?
  bankAccountNumber String? // Should be encrypted in production
  bankAccountType   String? // 'checking' | 'savings'
  bankAccountLast4  String? // Last 4 digits for display

  // Year-to-Date Tracking (reset annually)
  ytdGrossEarnings  Decimal @default(0) // Total gross (wages + tips + commission)
  ytdGrossWages     Decimal @default(0)
  ytdTips           Decimal @default(0)
  ytdCommission     Decimal @default(0)
  ytdTaxesWithheld  Decimal @default(0) // Total taxes (federal + state + FICA)
  ytdFederalTax     Decimal @default(0)
  ytdStateTax       Decimal @default(0)
  ytdLocalTax       Decimal @default(0)
  ytdSocialSecurity Decimal @default(0)
  ytdMedicare       Decimal @default(0)
  ytdNetPay         Decimal @default(0)
  ytdLastUpdated    DateTime?

  // Settings
  color     String? // For floor plan display
  avatarUrl String?

  // POS Layout Preferences (personal customization)
  posLayoutSettings Json? // Bar/Food mode, favorites, category order

  // Default screen after login: 'orders' | 'bar' | 'kds'
  defaultScreen     String?   @default("orders")
  // Default order type slug to pre-select
  defaultOrderType  String?

  // Room Order Preferences (for POS floor plan)
  preferredRoomOrder String? // JSON array of room IDs: ["room-1", "room-3", "room-2"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  orders           Order[]
  timeClockEntries TimeClockEntry[]
  shifts           Shift[]
  voidLogs         VoidLog[]
  auditLogs        AuditLog[]
  sections         SectionAssignment[]
  refundLogs       RefundLog[]

  // Tip sharing relations
  tipSharesGiven    TipShare[] @relation("TipShareFrom")
  tipSharesReceived TipShare[] @relation("TipShareTo")
  // Tip Bank Ledger (Skill 250)
  tipLedgers       TipLedger[]
  tipLedgerEntries TipLedgerEntry[]

  // Tip Groups (Skill 252)
  tipGroupMemberships TipGroupMembership[]

  // Order Ownership (Skill 253)
  orderOwnershipEntries OrderOwnershipEntry[]

  // Tip Adjustments & Compliance (Skills 256, 259)
  tipAdjustments       TipAdjustment[]
  cashTipDeclarations  CashTipDeclaration[]

  // Tip Debt (Skill 278 - Chargeback Remainder)
  tipDebts             TipDebt[]

  // Payroll & Scheduling
  payStubs           PayStub[]
  scheduledShifts    ScheduledShift[]
  availabilityEntries AvailabilityEntry[]

  // Remote void approval relations
  voidApprovalsRequested RemoteVoidApproval[] @relation("VoidRequester")
  voidApprovalsApproved  RemoteVoidApproval[] @relation("VoidApprover")

  // Daily Prep Count relations
  prepCountsCreated   DailyPrepCount[] @relation("PrepCountCreatedBy")
  prepCountsSubmitted DailyPrepCount[] @relation("PrepCountSubmittedBy")
  prepCountsApproved  DailyPrepCount[] @relation("PrepCountApprovedBy")

  // Stock adjustment relations
  ingredientStockAdjustments IngredientStockAdjustment[]

  // Error Reporting (Domain 16)
  errorLogs ErrorLog[]

  // Multi-role support
  employeeRoles EmployeeRole[]

  // Mobile Device Authentication (P2-E02)
  mobileSessions MobileSession[]

  // Shift Swap relations
  initiatedSwapRequests   ShiftSwapRequest[] @relation("SwapInitiator")
  receivedSwapRequests    ShiftSwapRequest[] @relation("SwapTarget")
  approvedSwapRequests    ShiftSwapRequest[] @relation("SwapApprover")

  @@unique([locationId, pin])
  @@index([locationId])
  @@index([roleId])
  @@index([locationId, isActive])
  @@index([locationId, isActive, deletedAt])
}

// ============================================
// MULTI-ROLE SUPPORT
// ============================================

model EmployeeRole {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  roleId     String
  role       Role     @relation(fields: [roleId], references: [id])

  isPrimary Boolean @default(false) // Matches Employee.roleId

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([employeeId, roleId])
  @@index([locationId])
  @@index([employeeId])
  @@index([roleId])
}

// ============================================
// TIME CLOCK (Skill 45)
// ============================================

model TimeClockEntry {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  clockIn  DateTime  @default(now())
  clockOut DateTime?

  // Break tracking
  breakStart   DateTime?
  breakEnd     DateTime?
  breakMinutes Int       @default(0)

  // Totals
  regularHours  Decimal?
  overtimeHours Decimal?

  // Cash drawer
  drawerCountIn  Json? // {denominations, total}
  drawerCountOut Json?

  notes String?

  // Multi-role: which role the employee is working as this entry
  workingRoleId String?
  workingRole   Role?   @relation("WorkingRole", fields: [workingRoleId], references: [id])

  // Tip group selected at clock-in (from TipGroupTemplate system)
  selectedTipGroupId String?

  // Reverse relation
  shifts Shift[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([employeeId])
  @@index([clockIn])
  @@index([locationId, employeeId, clockOut])
  @@index([locationId, clockIn])
}

// ============================================
// SHIFTS & DRAWER MANAGEMENT (Skill 37)
// ============================================

model Shift {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Cash management
  startingCash Decimal
  expectedCash Decimal?
  actualCash   Decimal?
  variance     Decimal?

  // Sales summary
  totalSales   Decimal?
  cashSales    Decimal?
  cardSales    Decimal?
  tipsDeclared Decimal?

  // Tip distribution tracking
  grossTips   Decimal? // Total tips before distribution
  tipOutTotal Decimal? // Amount tipped out to others
  netTips     Decimal? // Tips kept (gross - tipOut)

  notes  String?
  status String  @default("open") // open, closed

  // Link to time clock entry
  timeClockEntryId String?
  timeClockEntry   TimeClockEntry? @relation(fields: [timeClockEntryId], references: [id])

  // Multi-role: which role employee is working as
  workingRoleId String?
  workingRole   Role?   @relation("ShiftWorkingRole", fields: [workingRoleId], references: [id])

  // Physical drawer claimed (null for purse/none cash handling modes)
  drawerId String?
  drawer   Drawer? @relation(fields: [drawerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Tip shares distributed during this shift closeout
  tipShares TipShare[]

  // Cash tip declarations (Skill 259)
  cashTipDeclarations CashTipDeclaration[]

  @@index([locationId])
  @@index([employeeId])
  @@index([startedAt])
  @@index([timeClockEntryId])
  @@index([drawerId])
  @@index([locationId, status])
  @@index([locationId, startedAt])
  @@index([locationId, employeeId, status])
}

model Drawer {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name     String // "Drawer 1", "Bar Drawer"
  deviceId String? // Associated terminal
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  paidInOuts PaidInOut[]

  // Shifts that claimed this drawer
  shifts Shift[]

  @@index([locationId])
}

model PaidInOut {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  drawerId   String
  drawer     Drawer   @relation(fields: [drawerId], references: [id])

  type      String // "in" or "out"
  amount    Decimal
  reason    String
  reference String? // Check number, vendor, etc.

  employeeId String
  approvedBy String? // Manager who approved

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([drawerId])
  @@index([createdAt])
}

// ============================================
// PREP STATIONS / KDS ROUTING
// ============================================

model PrepStation {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Kitchen", "Bar", "Expo", "Grill", "Fryer"
  displayName String?
  color       String? // For KDS display theming

  // Station type
  stationType String @default("kitchen") // kitchen, bar, expo, prep

  // Display settings
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  // KDS settings
  showAllItems Boolean @default(false) // Expo sees all items
  autoComplete Int? // Auto-complete after X seconds (for non-interactive)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations - categories and items assigned to this station
  categories Category[]
  menuItems  MenuItem[]

  // KDS screens that display this station
  kdsScreens KDSScreenStation[]

  @@unique([locationId, name])
  @@index([locationId])
}

// ============================================
// COURSE CONFIGURATION (T013)
// ============================================

model CourseConfig {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  courseNumber  Int    // 1, 2, 3, 4, 5
  name          String // "Appetizers", "Soup/Salad", "Entrees", "Dessert", "After-Dinner"
  displayName   String? // Optional custom display name
  color         String? // Badge color (hex)
  autoFireDelay Int?   // Minutes after previous course to auto-fire (null = manual only)

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, courseNumber])
  @@index([locationId])
  @@index([sortOrder])
}

// ============================================
// MENU PROGRAMMING (Skill 03)
// ============================================

model Category {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String
  displayName String?
  description String?
  color       String?
  imageUrl    String?

  // Category Type - controls item builder, modifier filtering, and reporting
  // food, drinks, liquor, entertainment, combos, pizza
  categoryType String @default("food")

  // Display
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)
  showOnPOS  Boolean @default(true)
  showOnline Boolean @default(true)

  // Bartender View - which menu section this category appears in
  // bar, food, entertainment, all (shows in both bar and food)
  categoryShow String @default("all")

  // Kitchen routing
  prepStationId String?
  prepStation   PrepStation? @relation(fields: [prepStationId], references: [id])
  courseNumber  Int?

  // Printer routing - printers for items in this category
  // JSON array of printer IDs, e.g., ["printer-1", "printer-2"]
  printerIds Json?

  // Tag-based routing (Routing Engine) - inherited by items in this category
  // JSON array of route tags, e.g., ["grill", "made-to-order"]
  routeTags Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  menuItems MenuItem[]

  // Print routing rules for this category
  printRules PrintRule[]

  @@index([locationId])
  @@index([prepStationId])
  @@index([sortOrder])
  @@index([categoryType])
  @@index([locationId, isActive, deletedAt])
  @@index([locationId, sortOrder])
}

model MenuItem {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  // Identity
  name        String
  displayName String?
  description String?
  sku         String?
  imageUrl    String?

  // Pricing
  price   Decimal          // Cash price (or base price if no dual pricing)
  priceCC Decimal?         // Credit card price (for dual pricing)
  cost    Decimal?         // For profit tracking

  // Tax
  taxRate     Decimal? // Override location default
  isTaxExempt Boolean  @default(false)

  // Display & Behavior
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)
  showOnPOS  Boolean @default(true)
  showOnline Boolean @default(true)

  // Kitchen
  prepStationId String? // Override category station
  prepStation   PrepStation? @relation(fields: [prepStationId], references: [id])
  prepTime      Int? // Minutes
  courseNumber  Int? // Override category course

  // Printer routing - override category's printers for this item
  // JSON array of printer IDs, e.g., ["printer-1", "printer-2"]
  printerIds       Json?
  backupPrinterIds Json? // Backup printers if primary fails

  // Tag-based routing (Routing Engine) - overrides category's routeTags if set
  // JSON array of route tags, e.g., ["pizza", "expo-only"]
  routeTags Json?

  // Inventory
  trackInventory Boolean @default(false)
  currentStock   Int?
  lowStockAlert  Int?
  isAvailable    Boolean @default(true) // 86'd when false

  // Type
  itemType String @default("standard") // standard, combo, timed_rental

  // Combo Print Mode - how combo components print to stations
  // 'individual' - Each component follows its own print rules (burger→kitchen, drink→bar)
  // 'primary' - Entire combo prints to the combo's assigned printer
  // 'all' - Full combo ticket prints at ALL relevant stations
  comboPrintMode String? // null for non-combos, 'individual' | 'primary' | 'all'

  // Timed Rental Pricing (Skill 81) - for pool tables, dart boards, etc.
  timedPricing   Json? // { per15Min: 5.00, per30Min: 8.00, perHour: 15.00, minimum: 15 }
  // Per-minute pricing (replaces timedPricing JSON)
  ratePerMinute      Decimal?  // e.g., 0.25 = $0.25/min
  minimumCharge      Decimal?  // e.g., 15.00 = $15 minimum
  incrementMinutes   Int?      @default(15)  // Charges in blocks after minimum
  minimumMinutes Int? // Minimum rental time in minutes
  graceMinutes   Int? // Grace period before next increment

  // Prepaid packages - discounted upfront deals
  // Format: [{ minutes: 30, price: 10, label: "30 Min Deal" }, { minutes: 60, price: 15, label: "1 Hour Special" }]
  prepaidPackages    Json?

  // Happy Hour - automatic time-based discounts
  happyHourEnabled   Boolean?  @default(false)
  happyHourDiscount  Int?      @default(50)  // Percentage off (50 = 50% off)
  happyHourStart     String?   // "13:00" (1 PM in 24h format)
  happyHourEnd       String?   // "16:00" (4 PM in 24h format)
  happyHourDays      Json?     // ["monday", "tuesday", "wednesday", "thursday", "friday"]

  // Entertainment tracking (Skill 94-97)
  entertainmentStatus String? // 'available', 'in_use', 'maintenance'
  currentOrderId      String? // Links to order currently using this item
  currentOrderItemId  String? // Links to specific order item
  blockTimeMinutes    Int? // If set, sells in blocks (30, 60, 90 mins)
  maxConcurrentUses   Int?    @default(1) // For items with multiple units
  currentUseCount     Int?    @default(0) // Current number in use

  // Menu Scheduling (Skill 40)
  availableFrom String? // Time format "HH:mm" e.g., "06:00"
  availableTo   String? // Time format "HH:mm" e.g., "11:00"
  availableDays String? // Comma-separated days: "0,1,2,3,4,5,6" (0=Sunday)

  // Commission (Skill 29)
  commissionType  String? // 'fixed' | 'percent' | null
  commissionValue Decimal?

  // Liquor Pour Sizes - quick pricing options for liquor items
  // Stores enabled pour sizes and their multipliers: { shot: 1.0, double: 2.0, tall: 1.5, short: 0.75 }
  pourSizes            Json?
  defaultPourSize      String? // Default selection: 'shot', 'double', 'tall', 'short'
  applyPourToModifiers Boolean @default(false) // Apply pour multiplier to spirit modifiers too

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  modifierGroups         MenuItemModifierGroup[] // Legacy junction - kept for backwards compatibility
  ownedModifierGroups    ModifierGroup[] @relation("ItemModifierGroups") // NEW: Item-specific modifier groups
  orderItems             OrderItem[]
  upsellTriggers         UpsellConfig[]          @relation("TriggerItem")
  upsellSuggestions      UpsellConfig[]          @relation("SuggestionItem")
  comboComponentItems    ComboComponent[]        @relation("ComboComponentItem")
  comboComponentDefaults ComboComponent[]        @relation("ComboComponentDefault")
  comboOptions           ComboComponentOption[]

  // Liquor Builder - Recipe ingredients for cocktails
  recipeIngredients RecipeIngredient[]

  // Direct link to bottle product (for spirit items like "Patron Silver" on the menu)
  // This enables bottles to be the source of truth for liquor menu items
  linkedBottleProductId String?
  linkedBottleProduct   BottleProduct? @relation("LinkedBottleMenuItems", fields: [linkedBottleProductId], references: [id])

  // Modifiers that link to this item (for spirit upgrades, etc.)
  linkedModifiers Modifier[] @relation("LinkedModifierItem")

  // Menu Item Ingredients - what's in this item
  ingredients MenuItemIngredient[]

  // Recipe costing (Skill 115)
  recipe MenuItemRecipe?

  // Print routing rules for this specific item
  printRules PrintRule[]

  // Pizza Builder - specialty pizza configuration
  pizzaSpecialty PizzaSpecialty?

  // Floor Plan Elements linked to this item (for entertainment items)
  floorPlanElements FloorPlanElement[]

  @@unique([locationId, sku])
  @@index([locationId])
  @@index([categoryId])
  @@index([prepStationId])
  @@index([isActive, showOnPOS])
  @@index([locationId, isActive, deletedAt])
  @@index([locationId, isActive])
}

model ModifierGroup {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // NEW: Item ownership - each modifier group belongs to ONE specific menu item
  // This enables per-item reporting and customization without affecting other items
  menuItemId String?
  menuItem   MenuItem? @relation("ItemModifierGroups", fields: [menuItemId], references: [id], onDelete: Cascade)

  name        String
  displayName String?

  // Modifier Types: food, liquor, retail, entertainment, combo, universal (can have multiple)
  modifierTypes Json @default("[\"universal\"]")

  // Requirements
  minSelections Int     @default(0)
  maxSelections Int     @default(1)
  isRequired    Boolean @default(false)
  allowStacking Boolean @default(false) // Allow selecting the same modifier multiple times

  // Tiered pricing: define pricing tiers based on selection count
  // mode: "flat_tiers" = all selections use tier price, "free_threshold" = first N free then use modifier's own price
  // Example flat_tiers: { "mode": "flat_tiers", "tiers": [{ "upTo": 3, "price": 0 }, { "upTo": 4, "price": 0.75 }, { "upTo": null, "price": 1.50 }] }
  // Example free_threshold: { "mode": "free_threshold", "tiers": [{ "upTo": 3, "price": 0 }] }
  tieredPricingConfig Json?

  // Exclusion: groups with the same key on the same item prevent duplicate modifier selections
  // Example: Side Choice 1 and Side Choice 2 both have exclusionGroupKey: "side-choices"
  exclusionGroupKey String?

  // Online Ordering Override
  hasOnlineOverride Boolean @default(false) // Enable separate modifier management for online orders

  // Display
  sortOrder Int @default(0)

  // Liquor Builder - Spirit Group Configuration
  isSpiritGroup Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  modifiers Modifier[]
  menuItems MenuItemModifierGroup[] // Legacy junction - kept for backwards compatibility

  // Modifiers that use this group as a sub-modifier
  parentModifiers Modifier[] @relation("SubModifier")

  // Combo components that use this modifier group
  comboComponents ComboComponent[]

  // Liquor Builder - Spirit configuration
  spiritConfig SpiritModifierGroup?

  @@index([locationId])
  @@index([menuItemId])
}

model Modifier {
  id              String        @id @default(cuid())
  locationId      String
  location        Location      @relation(fields: [locationId], references: [id])
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  name        String
  displayName String?

  // Pricing
  // If linkedMenuItemId is set and price is 0, use linked item's price
  // If price > 0, it acts as a price override or upcharge
  price       Decimal  @default(0)
  priceType   String   @default("upcharge") // 'upcharge' (add to base), 'override' (replace base), 'from_item' (use linked item price)
  upsellPrice Decimal? // Special price when offered as upsell
  cost        Decimal?

  // Pre-modifier support - explicit boolean fields for each option
  // These work just like ingredient pre-mods for consistent inventory tracking
  allowNo      Boolean  @default(true)
  allowLite    Boolean  @default(false)
  allowOnSide  Boolean  @default(false)
  allowExtra   Boolean  @default(false)
  extraPrice   Decimal  @default(0) // Price when "extra" is selected

  // Per-modifier deduction multipliers (override location-level defaults)
  // null = fall back to location MultiplierSettings (0.5 for lite, 2.0 for extra)
  liteMultiplier  Decimal? // Multiplier applied when "Lite" selected (default 0.5x)
  extraMultiplier Decimal? // Multiplier applied when "Extra" selected (default 2.0x)

  // Legacy JSON field - kept for backwards compatibility
  allowedPreModifiers Json? // Array of allowed prefixes: ["no", "lite", "extra", "side"]
  extraUpsellPrice    Decimal? // Upsell price for "extra"

  // Link to ingredient for inventory deduction
  // When this modifier is ordered, deduct from this ingredient's stock
  ingredientId String?
  ingredient   Ingredient? @relation("ModifierIngredient", fields: [ingredientId], references: [id])

  // Sub-modifier support - when selected, prompts for additional modifiers
  childModifierGroupId String?
  childModifierGroup   ModifierGroup? @relation("SubModifier", fields: [childModifierGroupId], references: [id])

  // Commission (Skill 29)
  commissionType  String? // 'fixed' | 'percent' | null
  commissionValue Decimal?

  // Linked Menu Item - for spirit upgrades, links to actual menu item for pricing/reporting
  // When set, sales are tracked against this item for reporting purposes
  linkedMenuItemId String?
  linkedMenuItem   MenuItem? @relation("LinkedModifierItem", fields: [linkedMenuItemId], references: [id])

  // Liquor Builder - Spirit fields
  spiritTier            String? // 'well', 'call', 'premium', 'top_shelf'
  linkedBottleProductId String? // Links to bottle inventory
  linkedBottleProduct   BottleProduct? @relation(fields: [linkedBottleProductId], references: [id])
  pourSizeOz            Decimal? // Override default pour size

  // Display
  sortOrder Int     @default(0)
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  // Channel visibility (for online ordering overrides)
  showOnPOS    Boolean @default(true)  // Visible to servers on POS
  showOnline   Boolean @default(true)  // Visible for online ordering

  // Inventory tracking (Skill 115)
  isLabel      Boolean @default(false) // True = grouping only, no inventory tracking

  // Printer routing for modifiers
  // printerRouting: "follow" (default) = prints with main item
  //                 "also" = prints with main item AND to printerIds
  //                 "only" = prints ONLY to printerIds (not with main item)
  printerRouting String @default("follow")
  printerIds     Json?  // Array of printer IDs when routing is "also" or "only"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  orderItemModifiers OrderItemModifier[]

  // Print routing rules for this specific modifier
  printRules PrintRule[]

  // Inventory link (Skill 115)
  inventoryLink ModifierInventoryLink?

  @@index([locationId])
  @@index([modifierGroupId])
  @@index([childModifierGroupId])
  @@index([linkedBottleProductId])
  @@index([linkedMenuItemId])
  @@index([locationId, linkedMenuItemId])
}

model MenuItemModifierGroup {
  id              String        @id @default(cuid())
  locationId      String
  location        Location      @relation(fields: [locationId], references: [id])
  menuItemId      String
  menuItem        MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  sortOrder  Int     @default(0)
  showOnline Boolean @default(true) // Whether this modifier group appears for online ordering
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?


  @@unique([menuItemId, modifierGroupId])
  @@index([locationId])
  @@index([modifierGroupId])
  @@index([menuItemId])
}

// ============================================
// COMBO MEALS (Skill 59)
// ============================================

model ComboTemplate {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  menuItemId String   @unique // Links to MenuItem with itemType="combo"

  basePrice    Decimal
  comparePrice Decimal? // A la carte total for savings display

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  components ComboComponent[]

  @@index([locationId])
}

model ComboComponent {
  id              String        @id @default(cuid())
  locationId      String
  location        Location      @relation(fields: [locationId], references: [id])
  comboTemplateId String
  comboTemplate   ComboTemplate @relation(fields: [comboTemplateId], references: [id], onDelete: Cascade)

  slotName    String // "entree", "side", "drink"
  displayName String // "Choose Your Side"
  sortOrder   Int    @default(0)

  isRequired    Boolean @default(true)
  minSelections Int     @default(1)
  maxSelections Int     @default(1)

  // The menu item for this combo slot
  menuItemId String?
  menuItem   MenuItem? @relation("ComboComponentItem", fields: [menuItemId], references: [id])

  // Price override for the item itself (null = use item's default price)
  itemPriceOverride Decimal?

  // Per-modifier price overrides: { "modifierId": 0.00, ... }
  modifierPriceOverrides Json?

  // Legacy fields (kept for backward compatibility)
  modifierGroupId String?
  modifierGroup   ModifierGroup? @relation(fields: [modifierGroupId], references: [id])
  priceOverride   Decimal?
  defaultItemId   String?
  defaultItem     MenuItem?      @relation("ComboComponentDefault", fields: [defaultItemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  options ComboComponentOption[]

  @@index([locationId])
  @@index([modifierGroupId])
  @@index([menuItemId])
}

model ComboComponentOption {
  id               String         @id @default(cuid())
  locationId       String
  location         Location       @relation(fields: [locationId], references: [id])
  comboComponentId String
  comboComponent   ComboComponent @relation(fields: [comboComponentId], references: [id], onDelete: Cascade)

  menuItemId  String
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id])
  upcharge    Decimal  @default(0)
  sortOrder   Int      @default(0)
  isAvailable Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?


  @@unique([comboComponentId, menuItemId])
  @@index([locationId])
  @@index([menuItemId])
}

// ============================================
// TABLES & FLOOR PLAN (Skill 55)
// ============================================

model Section {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name  String // "Bar", "Patio", "Main Floor"
  color String?

  // Floor plan (Skill 80)
  posX        Int    @default(0)
  posY        Int    @default(0)
  width       Int    @default(400)
  height      Int    @default(300)
  shape       String @default("rectangle") // rectangle, polygon
  coordinates Json? // For polygon: [{x, y}, {x, y}, ...]

  // Floor plan dimensions in feet (for editor grid snapping)
  widthFeet    Float  @default(40)   // Room width in feet
  heightFeet   Float  @default(30)   // Room height in feet
  gridSizeFeet Float  @default(0.25) // Grid snap size in feet (0.25 = 3 inch)

  sortOrder Int     @default(0)
  isVisible Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  tables            Table[]
  assignments       SectionAssignment[]
  floorPlanElements FloorPlanElement[]

  @@index([locationId])
}

model SectionAssignment {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  sectionId  String
  section    Section  @relation(fields: [sectionId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  assignedAt   DateTime  @default(now())
  unassignedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?


  @@index([locationId])
  @@index([sectionId])
  @@index([employeeId])
  @@index([sectionId, unassignedAt, deletedAt])
}

model Table {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  sectionId  String?
  section    Section? @relation(fields: [sectionId], references: [id])

  name         String  // "Table 1", "Bar 3", "Patio A"
  abbreviation String? // Short display name for floor plan: "T1", "B3", "PA"
  capacity     Int     @default(4) // DEPRECATED: Use _count.seats or seats.length instead
  // ⚠️ This field can drift from actual seat count. Always use seatCount from API responses.

  // Floor plan position (Skill 80)
  posX     Int    @default(0)
  posY     Int    @default(0)
  width    Int    @default(80)
  height   Int    @default(80)
  rotation Int    @default(0) // Degrees 0-359
  shape       String @default("rectangle") // rectangle, circle, square, booth, bar
  seatPattern String @default("all_around") // all_around, front_only, three_sides, two_sides, inside

  // For timed rentals (pool tables, dart boards)
  isTimedRental Boolean @default(false)
  timedItemId   String? // Links to MenuItem for pricing

  // Status
  status   String  @default("available") // available, occupied, reserved, dirty, in_use
  isActive Boolean @default(true)

  // Default layout (admin-defined, used for reset-to-default)
  // Set via "Save as Default Layout" button in floor plan admin
  defaultPosX      Int?    // Admin-defined default X position
  defaultPosY      Int?    // Admin-defined default Y position
  defaultSectionId String? // Admin-defined default section

  // Locked items (T019) - bolted down furniture that cannot be moved
  isLocked         Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  orders                 Order[]
  reservations           Reservation[]
  timedSessions          TimedSession[]
  seats                  Seat[]
  tickets                Ticket[]
  eventConfigurations    EventTableConfig[]
  sourceTableOrderItems  OrderItem[] @relation("SourceTableOrderItems") // Items ordered from this table (virtual combine T-S notation)
  entertainmentWaitlist  EntertainmentWaitlist[]

  @@index([locationId])
  @@index([sectionId])
  @@index([status])
  @@index([locationId, status])
  @@index([locationId, isActive, deletedAt])
  @@index([locationId, sectionId])
}

// ============================================
// FLOOR PLAN ELEMENTS (Entertainment, Decorations)
// ============================================

model FloorPlanElement {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  sectionId  String?
  section    Section? @relation(fields: [sectionId], references: [id])

  name         String   // "Pool Table 1", "Dartboard A"
  abbreviation String?  // Short display name: "PT1", "DB-A"

  // Element classification
  elementType  String   @default("entertainment") // "entertainment", "decoration", "barrier", "stage"
  visualType   String   // "pool_table", "dartboard", "arcade", "foosball", "shuffleboard", etc.

  // Link to menu item (for entertainment items with pricing/sessions)
  linkedMenuItemId String?
  linkedMenuItem   MenuItem? @relation(fields: [linkedMenuItemId], references: [id])

  // Position & dimensions (in pixels, for rectangle/circle elements)
  posX     Int @default(100)
  posY     Int @default(100)
  width    Int @default(120)
  height   Int @default(80)
  rotation Int @default(0)

  // Geometry in feet (for wall/line elements, replaces posX/posY for lines)
  // JSON: { "type": "line", "start": { "x": 0, "y": 0 }, "end": { "x": 10, "y": 0 } }
  // Or: { "type": "rectangle", "x": 0, "y": 0, "width": 5, "height": 3 }
  // Or: { "type": "circle", "x": 5, "y": 5, "radius": 2 }
  geometry    Json?
  thickness   Float   @default(0.5) // Wall thickness in feet

  // Visual customization
  fillColor   String? // Override default SVG fill
  strokeColor String? // Override default SVG stroke
  opacity     Float   @default(1.0)

  // Status (for entertainment)
  status          String    @default("available") // "available", "in_use", "reserved", "maintenance"
  currentOrderId  String?   // Active order using this element
  sessionStartedAt DateTime?
  sessionExpiresAt DateTime?

  sortOrder Int     @default(0)
  isVisible Boolean @default(true)
  isLocked  Boolean @default(false) // Prevent moving

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  waitlistEntries EntertainmentWaitlist[]

  @@index([locationId])
  @@index([sectionId])
  @@index([linkedMenuItemId])
  @@index([status])
  @@index([locationId, elementType, isVisible])
}

model EntertainmentWaitlist {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Can be for a specific element OR any element of a type
  elementId    String?           // Specific element (e.g., "Pool Table 2")
  element      FloorPlanElement? @relation(fields: [elementId], references: [id])
  visualType   String?           // OR any of this type (e.g., "any pool_table")

  // Who's waiting
  tableId      String?  // Table that's waiting
  table        Table?   @relation(fields: [tableId], references: [id])
  customerName String?  // Walk-in name
  partySize    Int      @default(1)
  phone        String?  // For SMS notification

  // Status
  status       String   @default("waiting") // "waiting", "notified", "seated", "cancelled", "expired"
  position     Int      @default(0) // Queue position
  requestedAt  DateTime @default(now())
  notifiedAt   DateTime?
  seatedAt     DateTime?
  expiresAt    DateTime? // Auto-expire after X minutes if not claimed

  notes String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([elementId])
  @@index([visualType])
  @@index([status])
}

// ============================================
// ORDER TYPES (Configurable Order Workflow)
// ============================================

model OrderType {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Dine In", "Call-in", "Drive-through"
  slug        String // "dine_in", "call_in", "drive_through" (code reference)
  description String?
  color       String? // Badge color (hex)
  icon        String? // Icon name (e.g., "table", "phone", "car")
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  isSystem    Boolean @default(false) // True for built-in types (dine_in, bar_tab, takeout)

  // JSON Configuration Fields
  // Required fields: { "tableId": true, "tabName": true, "phone": true }
  requiredFields Json?

  // Optional fields: { "address": true, "pickupTime": true, "vehicleType": true }
  optionalFields Json?

  // Field definitions with labels, types, validation
  // { "phone": { "label": "Phone Number", "type": "phone", "placeholder": "555-123-4567" } }
  fieldDefinitions Json?

  // Workflow rules: { "requirePaymentBeforeSend": true, "requireTableSelection": true }
  workflowRules Json?

  // KDS display configuration: { "badgeText": "{customerName}", "showPickupTime": true }
  kdsConfig Json?

  // Kitchen ticket print formatting
  printConfig Json?

  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, slug])
  @@index([locationId])
  @@index([sortOrder])
}

// ============================================
// ORDERS (Skill 04)
// ============================================

model Order {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  // Customer tracking (Skill 51)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  // Order identification
  orderNumber   Int // Sequential per location per day
  displayNumber String? // Displayed number (e.g., "A23")

  // Split order tracking
  parentOrderId String? // If this is a split, reference to parent
  parentOrder   Order?  @relation("OrderSplits", fields: [parentOrderId], references: [id])
  splitOrders   Order[] @relation("OrderSplits")
  splitIndex    Int? // 1, 2, 3... for display as "31-1", "31-2"

  // Type & Context
  orderType    String     @default("dine_in") // Legacy: dine_in, takeout, delivery, bar_tab
  orderTypeId  String? // New: Reference to configurable OrderType
  orderTypeRef OrderType? @relation(fields: [orderTypeId], references: [id])
  tableId      String?
  table        Table?     @relation(fields: [tableId], references: [id])
  guestCount   Int        @default(1)

  // Atomic Seat Management (Skill 121)
  baseSeatCount   Int      @default(1)  // Original seat count when order opened
  extraSeatCount  Int      @default(0)  // Additional seats added (can be negative if removed)
  seatVersion     Int      @default(0)  // Monotonic counter for concurrency control
  seatTimestamps  Json?                 // When each seat was added: { "1": "2026-02-01T10:00:00Z", ... }

  tabName      String? // For bar tabs (auto-filled from cardholder name on chip)
  tabNickname  String? // Editable display name (e.g., "John S - Beard")
  tabStatus    String? // pending_auth | open | no_card | closed (null = not a tab)

  // Custom fields collected for this order type (e.g., phone, pickupTime, vehicleColor)
  customFields Json?

  // Status
  status String @default("open") // open, sent, paid, closed, voided, merged

  // Concurrency control (optimistic locking for multi-terminal conflict detection)
  version Int @default(1)

  // Timing
  openedAt DateTime  @default(now())
  sentAt   DateTime?
  paidAt   DateTime?
  closedAt DateTime?

  // Reopen tracking (for closed orders that are reopened)
  reopenedAt     DateTime?
  reopenedBy     String? // Employee ID who reopened
  reopenReason   String?

  // Totals
  subtotal         Decimal @default(0)
  discountTotal    Decimal @default(0)
  taxTotal         Decimal @default(0)
  taxFromInclusive Decimal @default(0)  // Tax backed out of inclusive items
  taxFromExclusive Decimal @default(0)  // Tax added on top of exclusive items
  tipTotal         Decimal @default(0)
  total            Decimal @default(0)

  // Dual Pricing (Skill 31)
  primaryPaymentMethod String? // 'cash' | 'card' - determines which price applies

  // Commission (Skill 29)
  commissionTotal Decimal @default(0)

  // Notes
  notes String?

  // Bar Tab Pre-auth (Skill 21)
  preAuthId        String? // Reference to pre-auth transaction
  preAuthAmount    Decimal?
  preAuthLast4     String? // Last 4 digits of held card
  preAuthCardBrand String? // Visa, Mastercard, etc.
  preAuthExpiresAt DateTime? // When the hold expires
  preAuthRecordNo  String? // Datacap RecordNo token for capture/increment
  preAuthReaderId  String? // Which reader did the pre-auth

  // Bottle Service (Phase 10)
  isBottleService       Boolean   @default(false)
  bottleServiceTierId   String?   // Linked tier
  bottleServiceDeposit  Decimal?  // Deposit amount pre-authorized
  bottleServiceMinSpend Decimal?  // Minimum spend requirement (from tier at time of creation)

  // Walkout Recovery (Phase 6)
  isWalkout       Boolean   @default(false)
  walkoutAt       DateTime?
  walkoutMarkedBy String?   // Employee who marked as walkout

  // Tab Rollover & Declined Capture
  rolledOverAt       DateTime?   // Set when order crosses business day boundary
  rolledOverFrom     String?     // "Shift: {shiftId}" or "EOD reset by {name}"
  captureDeclinedAt  DateTime?   // When last capture attempt was declined
  captureRetryCount  Int         @default(0) // Number of capture retry attempts
  lastCaptureError   String?     // Last decline reason text

  // Coursing (T013)
  currentCourse Int    @default(1) // Currently active course
  courseMode    String @default("off") // 'off' | 'manual' | 'auto'

  // Offline Sync (Store and Forward)
  offlineId        String?   @unique // UUID from terminal for deduplication
  offlineLocalId   String?   // Terminal-prefixed ID (e.g., "BAR1-102")
  offlineTimestamp DateTime? // When order was created offline
  offlineTerminalId String?  // Which terminal created this offline

  // Business day tracking (orders at 1 AM belong to previous day's business day)
  businessDayDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  items     OrderItem[]
  payments  Payment[]
  discounts OrderDiscount[]
  voidLogs  VoidLog[]
  cards     OrderCard[]
  syncAuditEntries SyncAuditEntry[]
  remoteVoidApprovals RemoteVoidApproval[]
  orderOwnerships     OrderOwnership[]
  tempSeats           Seat[]             @relation("tempSeats")
  refundLogs    RefundLog[]
  itemDiscounts OrderItemDiscount[]

  @@index([locationId])
  @@index([employeeId])
  @@index([tableId])
  @@index([customerId])
  @@index([status])
  @@index([openedAt])
  @@index([orderNumber, locationId])
  @@index([orderType])
  @@index([orderTypeId])
  @@index([parentOrderId])
  @@index([offlineId])
  @@index([locationId, status])
  @@index([locationId, status, createdAt])
  @@index([locationId, createdAt])
  @@index([tableId, status, deletedAt])
  @@index([locationId, status, openedAt])
  @@index([locationId, tabStatus])
  @@index([locationId, status, closedAt])
  @@index([locationId, orderType, status])
  @@index([locationId, paidAt])
  @@index([locationId, createdAt, status])
  @@index([locationId, businessDayDate])
}

model OrderItem {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  // Item details (snapshot at time of order)
  name     String
  price    Decimal
  quantity Int     @default(1)

  // Pour size (liquor items) — T-006
  pourSize       String?   // "shot", "double", "tall", "short" (null = no pour selection)
  pourMultiplier Decimal?  // 1.0, 2.0, 1.5, 0.75 (null = no pour multiplier applied)

  // Item-level pricing truth (Layer 2)
  cardPrice      Decimal?           // Computed card price at time of order (null if no dual pricing)
  isTaxInclusive Boolean  @default(false)  // Was this item tax-inclusive at time of sale?
  categoryType   String?            // Snapshot of category type at time of order

  // Seat tracking (Skill 24)
  seatNumber Int?

  // Virtual combine - source table for T-S notation (e.g., T2-S3)
  sourceTableId String? // Which table this item was ordered from
  sourceTable   Table?  @relation("SourceTableOrderItems", fields: [sourceTableId], references: [id])

  // Course (Skill 14)
  courseNumber Int?
  courseStatus String @default("pending") // pending, fired, ready, served

  // Hold & Fire (Skill 15)
  isHeld    Boolean   @default(false)
  holdUntil DateTime?
  firedAt   DateTime?

  // Per-item delay (e.g., 5m, 10m — item waits, then fires to kitchen)
  delayMinutes    Int?      // Delay preset in minutes (null = no delay)
  delayStartedAt  DateTime? // When the delay timer started (set by send route)

  // Kitchen status
  kitchenStatus String @default("pending") // pending, cooking, ready, delivered

  // KDS completion tracking
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  // Resend tracking
  resendCount  Int       @default(0)
  lastResentAt DateTime?
  resendNote   String? // Note from server when resending (e.g., "Make it well done")

  // Block time tracking (Skill 97)
  blockTimeMinutes   Int? // Duration purchased (30, 60, 90 mins)
  blockTimeStartedAt DateTime? // When block time started
  blockTimeExpiresAt DateTime? // Calculated expiration time

  // Special requests (Skill 48)
  specialNotes String?

  // Status
  status     String   @default("active") // active, voided, comped
  voidReason String?
  wasMade    Boolean? // Was item made before void/comp? For waste tracking

  // Totals
  modifierTotal Decimal @default(0)
  itemTotal     Decimal @default(0)

  // Commission (Skill 29)
  commissionAmount Decimal?

  // Shared Table Ownership (Skill 253) - who added this item
  addedByEmployeeId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  modifiers               OrderItemModifier[]
  ingredientModifications OrderItemIngredient[]

  // Pizza Builder - detailed pizza configuration
  pizzaData OrderItemPizza?

  // Item-level discounts (P2-D01)
  itemDiscounts OrderItemDiscount[]

  @@index([locationId])
  @@index([orderId])
  @@index([menuItemId])
  @@index([kitchenStatus])
  @@index([orderId, kitchenStatus])
  @@index([orderId, status])
  @@index([orderId, status, deletedAt])
}

model OrderItemModifier {
  id          String    @id @default(cuid())
  locationId  String
  location    Location  @relation(fields: [locationId], references: [id])
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierId  String? // Optional: null for combo component selections
  modifier    Modifier? @relation(fields: [modifierId], references: [id])

  // Snapshot at time of sale
  name        String
  price       Decimal // Actual price charged (may differ from item price if discounted)
  preModifier String? // "no", "lite", "extra", "side"
  depth       Int     @default(0) // Modifier hierarchy depth: 0=top, 1=child, 2=grandchild

  quantity Int @default(1)

  // Commission (Skill 29)
  commissionAmount Decimal?

  // Linked Item Snapshot - for reporting which menu item was actually sold
  // Even if ordered as a modifier, this tracks the underlying item for sales reporting
  linkedMenuItemId    String? // Snapshot of linked menu item at time of sale
  linkedMenuItemName  String? // Name snapshot for reporting
  linkedMenuItemPrice Decimal? // Original item price (before any discount/override)

  // Liquor Builder - Spirit snapshot for reporting
  spiritTier            String? // 'well', 'call', 'premium', 'top_shelf'
  linkedBottleProductId String? // Snapshot of bottle used for inventory

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([orderItemId])
  @@index([spiritTier])
  @@index([linkedMenuItemId])
}

// ============================================
// PAYMENTS (Skill 30)
// ============================================

model Payment {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id])
  employeeId String? // Who processed the payment

  // Cash drawer attribution (Phase: Role-Based Cash Handling)
  drawerId   String? // Which physical drawer received cash (null for card/purse)
  shiftId    String? // Which shift was active (for reconciliation)
  terminalId String? // Which terminal processed this payment

  // Payment details
  amount      Decimal
  tipAmount   Decimal @default(0)
  totalAmount Decimal

  // Method
  paymentMethod String // cash, credit, debit, gift_card, house_account

  // Cash details
  amountTendered     Decimal? // Amount given by customer
  changeGiven        Decimal? // Change returned
  roundingAdjustment Decimal? // Amount rounded (+ or -)

  // Card details (if card)
  cardBrand     String?
  cardLast4     String?
  authCode      String?
  transactionId String?

  // Datacap Direct integration
  paymentReaderId   String? // Which reader processed this payment
  datacapRefNumber  String? // Datacap reference for voids/refunds
  datacapRecordNo   String? // RecordNo token — needed for voids, adjustments, captures
  datacapSequenceNo String? // SequenceNo for audit trail
  entryMethod       String? // "Chip" | "Tap" | "Swipe" | "Manual"

  // Partial Approvals & Signature (Chargeback Defense)
  amountRequested  Decimal? // Original amount requested
  amountAuthorized Decimal? // Actual amount approved (may be less for partial approvals)
  signatureData    String?  // Base64 signature from reader (chargeback defense)

  // Status
  status String @default("completed") // pending, completed, refunded, voided

  // Refund tracking
  refundedAmount Decimal   @default(0)
  refundedAt     DateTime?
  refundReason   String?

  // Void tracking (separate from refunds - voids mark payment as invalid)
  voidedAt     DateTime?
  voidedBy     String? // Employee ID who voided
  voidReason   String?

  settledAt    DateTime?          // When payment was settled/batched by processor

  // Offline Payment Tracking (Store and Forward)
  offlineIntentId    String?   @unique // UUID from PaymentIntentManager for deduplication
  idempotencyKey     String?   @unique // Terminal+Order+Timestamp fingerprint for deduplication
  isOfflineCapture   Boolean   @default(false) // Was this captured while offline?
  offlineCapturedAt  DateTime? // When it was queued for offline capture
  offlineTerminalId  String?   // Which terminal processed this offline

  // Dual Pricing / Cash Discount (Visa Compliance)
  cashDiscountAmount  Decimal?  // Amount of cash discount applied (null if no dual pricing)
  priceBeforeDiscount Decimal?  // Original card price before cash discount
  pricingMode         String?   // "cash" or "card" — which price was used

  // Reconciliation (for EOD reports)
  needsReconciliation Boolean   @default(false) // Flag for accountant review
  reconciledAt        DateTime? // When verified against bank statement
  reconciledBy        String?   // Employee who verified

  // Sync audit tracking
  syncAttempts       Int       @default(0) // How many times sync was attempted
  wasDuplicateBlocked Boolean  @default(false) // Was a duplicate blocked by idempotency?

  processedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Refund logs (P2-P02)
  refundLogs   RefundLog[]

  @@index([locationId])
  @@index([orderId])
  @@index([processedAt])
  @@index([employeeId])
  @@index([isOfflineCapture])
  @@index([needsReconciliation])
  @@index([locationId, createdAt])
  @@index([locationId, paymentMethod, createdAt])
  @@index([locationId, status, createdAt])
  @@index([shiftId])
  @@index([drawerId])
  @@index([idempotencyKey])
  @@index([offlineIntentId])
}

// Sync Audit Entry - Tracks all sync events for idempotency audit log
model SyncAuditEntry {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Transaction details
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id])
  paymentId      String?  // If payment was created
  terminalId     String
  terminalName   String
  employeeId     String?

  // Amount
  amount Decimal

  // Idempotency tracking
  idempotencyKey String
  localIntentId  String?  // Original intent ID from terminal

  // Status: SUCCESS, DUPLICATE_BLOCKED, OFFLINE_SYNC, VOIDED, FAILED
  status      String
  statusNote  String?  // Additional context

  // Card details (for display)
  cardLast4 String?

  createdAt DateTime @default(now())

  // Sync fields
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([orderId])
  @@index([terminalId])
  @@index([status])
  @@index([createdAt])
  @@index([idempotencyKey])
  @@index([locationId, idempotencyKey])
}

// ============================================
// COUPONS (Skill 35)
// ============================================

model Coupon {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Coupon code
  code        String // e.g., "SAVE20", "WELCOME10"
  name        String // Display name
  description String?

  // Discount type
  discountType  String // 'percent' | 'fixed' | 'free_item'
  discountValue Decimal // Percent or dollar amount
  freeItemId    String? // If discountType is 'free_item'

  // Restrictions
  minimumOrder    Decimal? // Minimum order total
  maximumDiscount Decimal? // Cap on discount amount
  appliesTo       String   @default("order") // 'order' | 'category' | 'item'
  categoryIds     Json? // If appliesTo is 'category'
  itemIds         Json? // If appliesTo is 'item'

  // Usage limits
  usageLimit       Int? // Total uses allowed (null = unlimited)
  usageCount       Int     @default(0) // Current usage count
  perCustomerLimit Int? // Uses per customer (null = unlimited)
  singleUse        Boolean @default(false) // One-time use per customer

  // Validity
  validFrom  DateTime?
  validUntil DateTime?
  isActive   Boolean   @default(true)

  // Tracking
  createdBy String? // Employee who created

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  redemptions CouponRedemption[]

  @@unique([locationId, code])
  @@index([locationId])
  @@index([code])
  @@index([isActive])
  @@index([locationId, isActive, validUntil])
}

model CouponRedemption {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  couponId   String
  coupon     Coupon   @relation(fields: [couponId], references: [id])
  orderId    String
  customerId String? // If linked to customer

  discountAmount Decimal

  redeemedAt DateTime @default(now())
  redeemedBy String? // Employee who applied
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?


  @@index([locationId])
  @@index([couponId])
  @@index([orderId])
  @@index([customerId])
}

// ============================================
// RESERVATIONS (Skill 19)
// ============================================

model Reservation {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Guest info
  guestName  String
  guestPhone String?
  guestEmail String?
  partySize  Int

  // Timing
  reservationDate DateTime
  reservationTime String // HH:MM format
  duration        Int      @default(90) // Minutes

  // Table assignment
  tableId String?
  table   Table?  @relation(fields: [tableId], references: [id])

  // Status
  status String @default("confirmed") // confirmed, seated, completed, cancelled, no_show

  // Notes
  specialRequests String?
  internalNotes   String?

  // Link to customer profile
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  // Link to order when seated
  orderId String?

  // Bottle Service (P2-B03)
  bottleServiceTierId String?
  bottleServiceTier   BottleServiceTier? @relation(fields: [bottleServiceTierId], references: [id])

  // Tracking
  createdBy    String? // Employee who created
  seatedAt     DateTime?
  completedAt  DateTime?
  cancelledAt  DateTime?
  cancelReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([reservationDate])
  @@index([status])
  @@index([tableId])
  @@index([customerId])
  @@index([bottleServiceTierId])
  @@index([locationId, reservationDate, status])
}

// ============================================
// DISCOUNTS (Skills 18, 60)
// ============================================

model DiscountRule {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String
  displayText String
  description String?

  // Type
  discountType String // bogo, quantity, mix_match, threshold, time_based, manual

  // Trigger conditions
  triggerConfig Json // Category IDs, item IDs, quantities, etc.

  // Discount
  discountConfig Json // Percent, amount, fixed price, apply_to

  // Schedule (optional)
  scheduleConfig Json? // Days, times, date range

  // Rules
  priority         Int     @default(0)
  isStackable      Boolean @default(true)
  requiresApproval Boolean @default(false)
  maxPerOrder      Int?

  isActive            Boolean @default(true)
  isAutomatic         Boolean @default(false) // Auto-apply vs manual
  isEmployeeDiscount  Boolean @default(false) // Surfaces prominently in DiscountModal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  appliedDiscounts OrderDiscount[]
  itemDiscounts    OrderItemDiscount[]

  @@index([locationId])
  @@index([isActive, isAutomatic])
  @@index([locationId, isActive])
}

model OrderDiscount {
  id             String        @id @default(cuid())
  locationId     String
  location       Location      @relation(fields: [locationId], references: [id])
  orderId        String
  order          Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  discountRuleId String?
  discountRule   DiscountRule? @relation(fields: [discountRuleId], references: [id])

  name    String
  amount  Decimal
  percent Decimal?

  // Who applied it
  appliedBy   String? // Employee ID if manual
  isAutomatic Boolean @default(false)

  reason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([orderId])
}

// ============================================
// UPSELL PROMPTS (Skill 58)
// ============================================

model UpsellConfig {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Trigger
  triggerType       String // item, category, order_condition
  triggerItemId     String?
  triggerItem       MenuItem? @relation("TriggerItem", fields: [triggerItemId], references: [id])
  triggerCategoryId String?
  triggerCondition  Json?

  // Suggestion
  suggestionType       String // item, category, combo, upgrade
  suggestionItemId     String?
  suggestionItem       MenuItem? @relation("SuggestionItem", fields: [suggestionItemId], references: [id])
  suggestionCategoryId String?

  // Display
  promptText  String
  displayMode String  @default("inline") // inline, popup, toast
  showPrice   Boolean @default(true)

  // Timing
  triggerOnAdd      Boolean @default(true)
  triggerBeforeSend Boolean @default(false)
  triggerAtPayment  Boolean @default(false)

  // Status
  isActive Boolean @default(true)
  priority Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  events UpsellEvent[]

  @@index([locationId])
}

model UpsellEvent {
  id             String       @id @default(cuid())
  locationId     String
  location       Location     @relation(fields: [locationId], references: [id])
  upsellConfigId String
  upsellConfig   UpsellConfig @relation(fields: [upsellConfigId], references: [id])

  orderId    String
  employeeId String

  wasShown     Boolean @default(true)
  wasAccepted  Boolean @default(false)
  wasDismissed Boolean @default(false)

  addedAmount Decimal?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([upsellConfigId])
  @@index([createdAt])
}

// ============================================
// VOIDS & AUDIT (Skill 19)
// ============================================

model VoidLog {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  voidType String // item, order
  itemId   String? // If item void
  amount   Decimal
  reason   String
  wasMade  Boolean @default(false) // Was the item already made? For waste/loss tracking

  approvedById String?
  approvedAt   DateTime?

  // Remote approval reference
  remoteApprovalId String?
  remoteApproval   RemoteVoidApproval? @relation(fields: [remoteApprovalId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([orderId])
  @@index([employeeId])
  @@index([createdAt])
  @@index([locationId, createdAt])
}

// ============================================
// REMOTE VOID APPROVAL (Skill 121)
// SMS-based manager approval for voids when manager not present
// ============================================

model RemoteVoidApproval {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Request Details
  orderId       String
  order         Order    @relation(fields: [orderId], references: [id])
  orderItemId   String?  // If voiding specific item
  requestedById String
  requestedBy   Employee @relation("VoidRequester", fields: [requestedById], references: [id])
  voidReason    String
  voidType      String   // "item" | "order" | "comp"
  amount        Decimal
  itemName      String   // Cached for SMS
  orderNumber   Int      // Cached for SMS

  // Manager Assignment
  managerId    String
  manager      Employee @relation("VoidApprover", fields: [managerId], references: [id])
  managerPhone String   // Cached phone for SMS

  // SMS Tracking
  twilioMessageSid    String?
  approvalToken       String   @unique // 32 hex chars for web link
  approvalTokenExpiry DateTime          // 30 minutes

  // Approval Code (generated after approval)
  approvalCode       String?   // 6-digit code
  approvalCodeExpiry DateTime? // 5 minutes after approval

  // Status
  status          String    @default("pending") // pending | approved | rejected | expired | used
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  usedAt          DateTime? // When code was successfully entered

  // Terminal tracking for socket notifications
  requestingTerminalId String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  voidLogs VoidLog[]

  @@index([locationId])
  @@index([status])
  @@index([approvalToken])
  @@index([approvalCode, status])
  @@index([managerPhone, status])
  @@index([managerId])
  @@index([requestedById])
}

model AuditLog {
  id         String    @id @default(cuid())
  locationId String
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])

  action     String // login, logout, order_created, item_voided, etc.
  entityType String? // order, employee, menu_item, etc.
  entityId   String?
  details    Json? // Before/after values

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([employeeId])
  @@index([action])
  @@index([createdAt])
  @@index([locationId, createdAt])
}

// ============================================
// TIPPING (Skill 06)
// ============================================
// ⚠️ DEPRECATED MODELS (Skill 273): TipPool, TipPoolEntry, TipShare
// TipBank model REMOVED in Skill 284. These remaining legacy models are
// superseded by the TipLedger system (TipLedger, TipLedgerEntry, TipTransaction).
// All new tip flows use the ledger. These models are retained for historical
// data only. Do NOT write new code that creates records in these models.
// Report queries should read from TipLedgerEntry instead.
// ============================================

model TipPool {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Bar Pool", "Server Pool"
  description String?

  // Distribution rules
  distributionType String // equal, hours, points
  eligibleRoles    Json // Array of role IDs

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  entries TipPoolEntry[]

  @@index([locationId])
}

model TipPoolEntry {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  tipPoolId  String
  tipPool    TipPool  @relation(fields: [tipPoolId], references: [id])

  shiftDate   DateTime
  totalAmount Decimal

  // Distributions
  distributions Json // [{employeeId, amount, hours, points}]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([tipPoolId])
  @@index([shiftDate])
}

// ============================================
// TIP SHARING & TIP-OUTS (Role-based & Custom)
// ============================================

// Defines automatic tip-out percentages by role
// e.g., Server tips out 3% to Busser, 2% to Bartender
model TipOutRule {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  fromRoleId String // Role that tips out (Server)
  fromRole   Role   @relation("TipOutFrom", fields: [fromRoleId], references: [id])
  toRoleId   String // Role that receives (Busser, Bartender)
  toRole     Role   @relation("TipOutTo", fields: [toRoleId], references: [id])

  percentage Decimal // e.g., 3.0 for 3%
  isActive   Boolean @default(true)

  // Enhanced tip-out fields (Skill 251)
  basisType        String   @default("tips_earned") // tips_earned, food_sales, bar_sales, total_sales, net_sales
  salesCategoryIds Json?    // Optional category filter for sales-based rules
  maxPercentage    Decimal? // Compliance cap (max % of tips/sales)
  effectiveDate    DateTime? // Rule becomes active on this date
  expiresAt        DateTime? // Rule expires after this date

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  tipShares TipShare[]

  @@unique([locationId, fromRoleId, toRoleId])
  @@index([locationId])
  @@index([fromRoleId])
  @@index([toRoleId])
}

// @deprecated — Use TipLedgerEntry with sourceType='ROLE_TIPOUT' instead (Skill 273)
// Records actual tip distributions (both automatic role-based and custom one-off)
model TipShare {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  shiftId String? // Link to shift closeout (optional)
  shift   Shift?  @relation(fields: [shiftId], references: [id])

  fromEmployeeId String
  fromEmployee   Employee @relation("TipShareFrom", fields: [fromEmployeeId], references: [id])
  toEmployeeId   String
  toEmployee     Employee @relation("TipShareTo", fields: [toEmployeeId], references: [id])

  amount    Decimal
  shareType String // 'role_tipout' | 'custom' | 'pool'
  ruleId    String? // Reference to TipOutRule if role-based
  rule      TipOutRule? @relation(fields: [ruleId], references: [id])

  status      String    @default("pending") // pending, collected, banked, paid_out
  collectedAt DateTime?

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([shiftId])
  @@index([fromEmployeeId])
  @@index([toEmployeeId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// TIP BANK LEDGER (Skill 250)
// ============================================

model TipLedger {
  id                  String   @id @default(cuid())
  locationId          String
  location            Location @relation(fields: [locationId], references: [id])
  employeeId          String   @unique
  employee            Employee @relation(fields: [employeeId], references: [id])
  currentBalanceCents Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  deletedAt           DateTime?
  syncedAt            DateTime?
  entries             TipLedgerEntry[]

  @@index([locationId])
  @@index([employeeId])
}

model TipLedgerEntry {
  id            String    @id @default(cuid())
  locationId    String
  location      Location  @relation(fields: [locationId], references: [id])
  ledgerId      String
  ledger        TipLedger @relation(fields: [ledgerId], references: [id])
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id])
  type          String    // 'CREDIT' | 'DEBIT'
  amountCents   Int
  sourceType    String    // DIRECT_TIP, TIP_GROUP, ROLE_TIPOUT, MANUAL_TRANSFER, PAYOUT_CASH, PAYOUT_PAYROLL, CHARGEBACK, ADJUSTMENT
  sourceId      String?
  memo          String?
  adjustmentId  String?
  shiftId       String?
  orderId        String?
  idempotencyKey String?   @unique // Skill 274: dedup guard (e.g. "tip-ledger:{orderId}:{paymentId}:{employeeId}")
  createdAt      DateTime  @default(now())
  deletedAt      DateTime?
  syncedAt       DateTime?

  @@index([locationId])
  @@index([ledgerId])
  @@index([employeeId])
  @@index([sourceType])
  @@index([shiftId])
  @@index([createdAt])
}

model TipTransaction {
  id                String   @id @default(cuid())
  locationId        String
  location          Location @relation(fields: [locationId], references: [id])
  orderId           String
  paymentId         String?
  tipGroupId        String?
  segmentId         String?
  amountCents       Int
  sourceType        String   // 'CARD' | 'CASH' | 'ADJUSTMENT'
  kind              String   @default("tip") // Skill 277: 'tip' | 'service_charge' | 'auto_gratuity'
  collectedAt       DateTime
  primaryEmployeeId String?
  ccFeeAmountCents  Int       @default(0)
  idempotencyKey    String?   @unique // Skill 274: dedup guard (e.g. "tip-txn:{orderId}:{paymentId}")
  createdAt         DateTime @default(now())
  deletedAt         DateTime?
  syncedAt          DateTime?

  @@index([locationId])
  @@index([orderId])
  @@index([tipGroupId])
  @@index([collectedAt])
}

// ============================================
// TIP GROUP TEMPLATES (Admin-defined team pools)
// ===============================================

model TipGroupTemplate {
  id              String   @id @default(cuid())
  locationId      String
  location        Location @relation(fields: [locationId], references: [id])
  name            String   // "Downstairs Servers", "Bar Team", etc.
  allowedRoleIds  Json     // Array of role IDs that can join this team
  defaultSplitMode String  @default("equal") // equal, hours_weighted, role_weighted
  active          Boolean  @default(true)
  sortOrder       Int      @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  tipGroups TipGroup[] // Runtime group instances for this template

  @@index([locationId])
  @@index([active])
}

// TIP GROUPS (Skill 252 - Dynamic Tip Groups)
// ============================================

model TipGroup {
  id         String    @id @default(cuid())
  locationId String
  location   Location  @relation(fields: [locationId], references: [id])
  createdBy  String    // Employee who started the group
  ownerId    String    // Current owner (for approvals)
  registerId String?   // Terminal/register
  templateId String?   // Links to admin-defined TipGroupTemplate (null = ad-hoc group)
  template   TipGroupTemplate? @relation(fields: [templateId], references: [id])
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  status     String    @default("active") // active, closed
  splitMode  String    @default("equal")  // equal, custom, role_weighted, hours_weighted
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  syncedAt   DateTime?

  memberships TipGroupMembership[]
  segments    TipGroupSegment[]

  @@index([locationId])
  @@index([status])
  @@index([startedAt])
  @@index([ownerId])
  @@index([templateId])
}

model TipGroupMembership {
  id         String    @id @default(cuid())
  locationId String
  location   Location  @relation(fields: [locationId], references: [id])
  groupId    String
  group      TipGroup  @relation(fields: [groupId], references: [id])
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id])
  joinedAt   DateTime  @default(now())
  leftAt     DateTime?
  role       String?   // For role-weighted splits
  approvedBy String?   // Owner who approved join
  status     String    @default("active") // active, left, pending_approval
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  syncedAt   DateTime?

  @@index([groupId])
  @@index([employeeId])
  @@index([status])
  @@index([locationId])
  @@index([locationId, status])
}

model TipGroupSegment {
  id          String    @id @default(cuid())
  locationId  String
  location    Location  @relation(fields: [locationId], references: [id])
  groupId     String
  group       TipGroup  @relation(fields: [groupId], references: [id])
  startedAt   DateTime
  endedAt     DateTime?
  memberCount Int
  splitJson   Json      // { "emp1": 0.5, "emp2": 0.5 }
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?
  syncedAt    DateTime?

  @@index([groupId])
  @@index([startedAt])
  @@index([locationId])
}

// ============================================
// TIP DEBT (Skill 278 - Chargeback Remainder)
// ============================================

model TipDebt {
  id                  String    @id @default(cuid())
  locationId          String
  location            Location  @relation(fields: [locationId], references: [id])
  employeeId          String
  employee            Employee  @relation(fields: [employeeId], references: [id])
  originalAmountCents Int       // What was owed at chargeback time
  remainingCents      Int       // What's still outstanding
  sourcePaymentId     String    // The payment that triggered chargeback
  sourceType          String    @default("CHARGEBACK")
  memo                String?
  status              String    @default("open") // open | partial | recovered | written_off
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  recoveredAt         DateTime?
  writtenOffAt        DateTime?
  writtenOffBy        String?
  deletedAt           DateTime?
  syncedAt            DateTime?

  @@index([locationId])
  @@index([employeeId])
  @@index([status])
}

// ============================================
// ORDER OWNERSHIP (Skill 253 - Shared Tables)
// ============================================

model OrderOwnership {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  createdById String   // Employee who set the split
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  syncedAt    DateTime?
  owners      OrderOwnershipEntry[]

  @@index([orderId])
  @@index([locationId])
}

model OrderOwnershipEntry {
  id               String         @id @default(cuid())
  orderOwnershipId String
  ownership        OrderOwnership @relation(fields: [orderOwnershipId], references: [id])
  employeeId       String
  employee         Employee       @relation(fields: [employeeId], references: [id])
  sharePercent     Float          // e.g., 50.0, 33.33

  @@index([orderOwnershipId])
  @@index([employeeId])
}

// ============================================
// TIP ADJUSTMENTS (Skill 256)
// ============================================

model TipAdjustment {
  id              String   @id @default(cuid())
  locationId      String
  location        Location @relation(fields: [locationId], references: [id])
  createdById     String
  createdBy       Employee @relation(fields: [createdById], references: [id])
  reason          String
  adjustmentType  String   // 'group_membership' | 'ownership_split' | 'clock_fix' | 'manual_override' | 'tip_amount'
  contextJson     String   // JSON: before/after state
  autoRecalcRan   Boolean  @default(false)
  createdAt       DateTime @default(now())
  deletedAt       DateTime?
  syncedAt        DateTime?

  @@index([locationId])
  @@index([createdById])
  @@index([createdAt])
}

// ============================================
// CASH TIP DECLARATIONS (Skill 259)
// ============================================

model CashTipDeclaration {
  id             String   @id @default(cuid())
  locationId     String
  location       Location @relation(fields: [locationId], references: [id])
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id])
  shiftId        String?
  shift          Shift?   @relation(fields: [shiftId], references: [id])
  amountCents    Int
  declaredAt     DateTime @default(now())
  source         String   @default("employee") // 'employee' | 'manager_override'
  overrideReason String?
  overrideBy     String?
  createdAt      DateTime @default(now())
  deletedAt      DateTime?
  syncedAt       DateTime?

  @@index([locationId])
  @@index([employeeId])
  @@index([shiftId])
}

// ============================================
// GIFT CARDS (Skill 32)
// ============================================

model GiftCard {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Card identification
  cardNumber String  @unique // Unique code (e.g., "GC-1234-5678-9012")
  pin        String? // Optional PIN for security

  // Balance
  initialBalance Decimal
  currentBalance Decimal

  // Status
  status String @default("active") // active, depleted, expired, frozen

  // Validity
  purchasedAt  DateTime  @default(now())
  expiresAt    DateTime?
  frozenAt     DateTime?
  frozenReason String?

  // Purchaser info (optional)
  purchasedById  String? // Employee who sold it
  recipientName  String?
  recipientEmail String?
  recipientPhone String?
  purchaserName  String?
  message        String? // Gift message

  // Tracking
  orderId String? // Order where it was purchased

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  transactions GiftCardTransaction[]

  @@index([locationId])
  @@index([cardNumber])
  @@index([status])
}

model GiftCardTransaction {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  giftCardId String
  giftCard   GiftCard @relation(fields: [giftCardId], references: [id])

  // Transaction type
  type String // purchase, redemption, reload, refund, adjustment

  // Amounts
  amount        Decimal
  balanceBefore Decimal
  balanceAfter  Decimal

  // Reference
  orderId    String? // Order where used
  employeeId String? // Employee who processed
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([giftCardId])
  @@index([orderId])
  @@index([createdAt])
}

// ============================================
// HOUSE ACCOUNTS (Skill 33)
// ============================================

model HouseAccount {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Account holder
  name        String // Individual or business name
  contactName String? // Contact person if business
  email       String?
  phone       String?
  address     String?

  // Credit settings
  creditLimit    Decimal @default(0)
  currentBalance Decimal @default(0) // Positive = owes money
  paymentTerms   Int     @default(30) // Days until due

  // Status
  status          String    @default("active") // active, suspended, closed
  suspendedAt     DateTime?
  suspendedReason String?

  // Billing
  billingCycle String    @default("monthly") // monthly, weekly, on_demand
  lastBilledAt DateTime?
  nextBillDate DateTime?

  // Tax
  taxExempt Boolean @default(false)
  taxId     String? // Tax exempt ID

  // Link to customer profile (optional)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  transactions HouseAccountTransaction[]

  @@unique([locationId, name])
  @@index([locationId])
  @@index([status])
}

model HouseAccountTransaction {
  id             String       @id @default(cuid())
  locationId     String
  location       Location     @relation(fields: [locationId], references: [id])
  houseAccountId String
  houseAccount   HouseAccount @relation(fields: [houseAccountId], references: [id])

  // Transaction type
  type String // charge, payment, adjustment, credit

  // Amounts
  amount        Decimal
  balanceBefore Decimal
  balanceAfter  Decimal

  // Reference
  orderId         String? // Order that was charged
  employeeId      String? // Employee who processed
  paymentMethod   String? // For payments: check, cash, card, etc.
  referenceNumber String? // Check number, etc.
  notes           String?

  // Due date (for charges)
  dueDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([houseAccountId])
  @@index([orderId])
  @@index([createdAt])
}

// ============================================
// TIMED RENTALS (Skill 81) - Pool tables, dart boards, etc.
// ============================================

model TimedSession {
  id         String  @id @default(cuid())
  locationId String
  menuItemId String // The timed rental item (for pricing)
  tableId    String? // The physical table/equipment being used
  table      Table?  @relation(fields: [tableId], references: [id])
  orderId    String? // Linked order for billing

  // Session timing
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  pausedAt      DateTime? // If currently paused
  pausedMinutes Int       @default(0) // Total paused time

  // Calculated on close
  totalMinutes Int?
  totalCharge  Decimal?

  // Billing
  rateType   String  @default("hourly") // per15Min, per30Min, hourly, custom
  rateAmount Decimal

  // Status
  status String @default("active") // active, paused, completed, cancelled

  // Who started/ended
  startedById String?
  endedById   String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([menuItemId])
  @@index([tableId])
  @@index([status])
  @@index([startedAt])
}

// ============================================
// SEAT-LEVEL TICKETING
// Seats, Events, Tickets for shows, concerts, private events
// ============================================

model Seat {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  tableId    String
  table      Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  // Identity
  label      String // "1", "A", "A1" - displayed on floor plan
  seatNumber Int // Sequential within table (1, 2, 3...)

  // Relative positioning within table (offset from table center in pixels)
  relativeX Int @default(0)
  relativeY Int @default(0)
  angle     Int @default(0) // Facing direction (0-359 degrees)

  // Original positions from floor plan builder (for restore after combine/split)
  originalRelativeX Int? // Saved X position before combine
  originalRelativeY Int? // Saved Y position before combine
  originalAngle     Int? // Saved angle before combine

  // Seat properties
  seatType String @default("standard") // standard, premium, accessible, booth_end

  // Temporary seat (created by POS when server adds extra seats)
  isTemporary    Boolean  @default(false) // true = created by POS, not editor
  sourceOrderId  String?                  // order that created this temp seat
  sourceOrder    Order?   @relation("tempSeats", fields: [sourceOrderId], references: [id])

  // Status tracking
  status             String  @default("available") // available, occupied, reserved
  currentOrderItemId String? // Currently active order item at this seat

  // Historical tracking
  lastOccupiedAt DateTime? // When seat was last occupied
  lastOccupiedBy String?   // Customer name or order reference

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  tickets Ticket[]

  @@unique([tableId, seatNumber])
  @@index([locationId])
  @@index([tableId])
  @@index([sourceOrderId])
}

model Event {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Event Details
  name        String
  description String?
  imageUrl    String?

  // Type determines booking behavior
  eventType String @default("dinner_show") // dinner_show, concert, private_event, special_occasion

  // Timing
  eventDate DateTime
  doorsOpen String // HH:MM format
  startTime String // HH:MM format
  endTime   String? // HH:MM format (optional)

  // Ticketing Configuration
  ticketingMode      String  @default("per_seat") // per_seat, per_table, general_admission, hybrid
  allowOnlineSales   Boolean @default(true)
  allowPOSSales      Boolean @default(true)
  maxTicketsPerOrder Int?

  // Capacity
  totalCapacity    Int
  reservedCapacity Int @default(0) // Held for walk-ins or VIPs

  // Sales Window
  salesStartAt DateTime?
  salesEndAt   DateTime?

  // Status
  status   String  @default("draft") // draft, on_sale, sold_out, cancelled, completed
  isActive Boolean @default(true)

  // Settings stored as JSON for flexibility
  settings Json?

  // Reservation Conflict Handling
  reservationConflictsHandled Boolean @default(false)
  reservationConflictNotes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?
  createdBy String? // Employee who created

  // Relations
  pricingTiers        EventPricingTier[]
  tickets             Ticket[]
  tableConfigurations EventTableConfig[]

  @@index([locationId])
  @@index([eventDate])
  @@index([status])
}

model EventPricingTier {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  eventId    String
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Tier Details
  name        String // "General Admission", "VIP", "Premium Front Row"
  description String?
  color       String? // For floor plan display

  // Pricing
  price      Decimal
  serviceFee Decimal @default(0)

  // Quantity limits
  quantityAvailable Int? // null = unlimited
  quantitySold      Int  @default(0)
  maxPerOrder       Int? // Limit per transaction

  // Which sections/tables this tier applies to (JSON array of section IDs)
  sectionIds Json?

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  tickets             Ticket[]
  tableConfigurations EventTableConfig[]

  @@index([locationId])
  @@index([eventId])
}

model EventTableConfig {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  eventId    String
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tableId    String
  table      Table    @relation(fields: [tableId], references: [id])

  // Per-event table settings
  isIncluded    Boolean           @default(true) // Include this table in event
  bookingMode   String            @default("inherit") // inherit, per_seat, per_table, disabled
  pricingTierId String?
  pricingTier   EventPricingTier? @relation(fields: [pricingTierId], references: [id])

  // For per-table booking: min/max party size
  minPartySize Int?
  maxPartySize Int? // null = use table capacity
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?


  @@unique([eventId, tableId])
  @@index([locationId])
  @@index([eventId])
  @@index([tableId])
}

model Ticket {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  eventId    String
  event      Event    @relation(fields: [eventId], references: [id])

  // Pricing
  pricingTierId String
  pricingTier   EventPricingTier @relation(fields: [pricingTierId], references: [id])

  // Seat Assignment (nullable for GA)
  tableId String?
  table   Table?  @relation(fields: [tableId], references: [id])
  seatId  String?
  seat    Seat?   @relation(fields: [seatId], references: [id])

  // Ticket Identification
  ticketNumber String @unique // Human-readable: EVT-20260128-001
  barcode      String @unique // Scannable code

  // Customer Info
  customerName  String?
  customerEmail String?
  customerPhone String?
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])

  // Pricing Snapshot (at time of purchase)
  basePrice  Decimal
  serviceFee Decimal @default(0)
  taxAmount  Decimal @default(0)
  totalPrice Decimal

  // Status
  status String @default("available") // available, held, sold, checked_in, cancelled, refunded

  // Hold Information (for cart/checkout flow)
  heldAt          DateTime?
  heldUntil       DateTime?
  heldBySessionId String? // Browser session or POS session

  // Purchase Information
  purchasedAt     DateTime?
  purchaseChannel String? // pos, online, phone, comp
  orderId         String? // Link to POS Order for F&B
  paymentId       String? // Payment reference

  // Check-in
  checkedInAt DateTime?
  checkedInBy String? // Employee ID

  // Cancellation/Refund
  cancelledAt  DateTime?
  cancelReason String?
  refundedAt   DateTime?
  refundAmount Decimal?
  refundedBy   String? // Employee ID

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([eventId])
  @@index([tableId])
  @@index([seatId])
  @@index([customerId])
  @@index([status])
  @@index([ticketNumber])
  @@index([barcode])
}

// ============================================
// TAX RULES (Skill 36) - Multiple tax rates
// ============================================

model TaxRule {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name String // "State Tax", "City Tax", "Alcohol Tax"
  rate Decimal // 0.0825 = 8.25%

  // Application rules
  appliesTo   String @default("all") // all, category, item
  categoryIds Json? // If appliesTo is 'category'
  itemIds     Json? // If appliesTo is 'item'

  // Tax-inclusive pricing
  isInclusive Boolean @default(false)

  // Order
  priority     Int     @default(0) // For stacking order
  isCompounded Boolean @default(false) // Calculate on subtotal+previous taxes

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([isActive])
  @@index([locationId, isActive, isInclusive])
}

// ============================================
// INVENTORY TRACKING (Skill 38)
// ============================================

model InventoryTransaction {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  menuItemId String

  // Transaction type
  type String // sale, purchase, adjustment, waste, transfer, count

  // Quantities
  quantityBefore Int
  quantityChange Int // Negative for sales/waste, positive for purchases
  quantityAfter  Int

  // Reference
  orderId       String? // If from a sale
  employeeId    String? // Who made the change
  vendorName    String? // If purchase
  invoiceNumber String? // If purchase
  reason        String? // For adjustments/waste

  // Cost tracking
  unitCost  Decimal?
  totalCost Decimal?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([menuItemId])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// STOCK ALERTS (Skill 39)
// ============================================

model StockAlert {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  menuItemId String

  alertType    String // low_stock, out_of_stock, reorder
  currentStock Int
  threshold    Int // The level that triggered the alert

  // Status
  status String @default("active") // active, acknowledged, resolved

  acknowledgedAt DateTime?
  acknowledgedBy String?
  resolvedAt     DateTime?
  resolvedBy     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([menuItemId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// INVENTORY & RECIPE COSTING (Skill 115)
// ============================================

// Void reasons with automatic inventory deduction flag
model VoidReason {
  id              String   @id @default(cuid())
  locationId      String
  location        Location @relation(fields: [locationId], references: [id])

  name            String   // "Kitchen Error - Made", "Customer Changed Mind"
  description     String?
  deductInventory Boolean  @default(false) // Auto-deduct from theoretical inventory
  requiresManager Boolean  @default(false) // Requires manager PIN
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, name])
  @@index([locationId])
}

// Storage locations for inventory (Walk-in, Dry Storage, Bar, etc.)
model StorageLocation {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  name        String   // "Main Walk-in", "Bar Well 1", "Dry Storage"
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  inventoryItems  InventoryItemStorage[]
  inventoryCounts InventoryCount[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, name])
  @@index([locationId])
}

// Core inventory item - everything you purchase
model InventoryItem {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  // Identity
  name        String   // "Chicken Breast", "Tito's Vodka"
  sku         String?  // Optional SKU/barcode
  description String?

  // Classification - CRITICAL FOR COGS REPORTING
  department    String   // "Food", "Beverage", "Retail" - for P&L COGS split
  itemType      String   // "food", "liquor", "beer", "wine", "supply"
  revenueCenter String   // "kitchen", "bar"
  category      String   // "protein", "dairy", "whiskey", "vodka"
  subcategory   String?  // "bourbon", "scotch"
  brand         String?  // "Tyson", "Tito's"

  // Purchase info
  purchaseUnit     String   // "case", "lb", "bottle", "each"
  purchaseSize     Decimal  // 15 (for 15lb case), 1 (for single bottle)
  purchaseCost     Decimal  // $65.00 per case
  defaultVendorId  String?
  defaultVendor    Vendor?  @relation("DefaultVendor", fields: [defaultVendorId], references: [id])

  // Storage/usage unit (what you count in)
  storageUnit      String   // "oz", "each", "bottle"
  unitsPerPurchase Decimal  // 240 oz per 15lb case
  costPerUnit      Decimal  // Auto-calc: purchaseCost / unitsPerPurchase

  // Costing method & tracking
  costingMethod    String   @default("weighted_average") // "weighted_average" or "fifo"
  lastPriceUpdate  DateTime? // When cost was last updated
  priceSource      String   @default("manual") // "manual", "invoice", "api"

  // Yield (for items with waste)
  yieldPercent     Decimal  @default(100) // 75% = 25% trim/cooking loss
  yieldCostPerUnit Decimal? // Cost adjusted for yield

  // For liquor items
  spiritCategoryId String?
  spiritCategory   SpiritCategory? @relation("InventoryItemSpirit", fields: [spiritCategoryId], references: [id])
  pourSizeOz       Decimal?  // Standard pour size (overrides location default)
  proofPercent     Decimal?  // Alcohol proof

  // Inventory levels (aggregate across all storage locations)
  currentStock     Decimal  @default(0)  // Total in storage units
  parLevel         Decimal? // Minimum to keep on hand (total)
  reorderPoint     Decimal? // When to reorder
  reorderQty       Decimal? // How much to order

  // Status
  isActive         Boolean  @default(true)
  trackInventory   Boolean  @default(true)

  // Relations
  storageLocations InventoryItemStorage[]
  prepItemInputs   PrepItemIngredient[]
  recipeUsages     MenuItemRecipeIngredient[]
  modifierLinks    ModifierInventoryLink[]
  countItems       InventoryCountItem[]
  transactions     InventoryItemTransaction[]
  invoiceLines     InvoiceLineItem[]
  wasteEntries     WasteLogEntry[]

  // Pizza component relations (Skill 115)
  pizzaCrusts      PizzaCrust[]   @relation("PizzaCrustInventory")
  pizzaSauces      PizzaSauce[]   @relation("PizzaSauceInventory")
  pizzaCheeses     PizzaCheese[]  @relation("PizzaCheeseInventory")
  pizzaToppings    PizzaTopping[] @relation("PizzaToppingInventory")

  // Ingredients that link to this inventory item for deduction
  ingredientLinks  Ingredient[]   @relation("IngredientInventoryLink")

  // Reverse relation from BottleProduct
  bottleProduct BottleProduct? @relation("BottleInventoryLink")

  // Daily prep count deductions
  dailyPrepCountTransactions DailyPrepCountTransaction[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, name])
  @@index([locationId])
  @@index([department])
  @@index([itemType])
  @@index([revenueCenter])
  @@index([category])
  @@index([locationId, category])
}

// Links inventory items to storage locations (item can be in multiple locations)
model InventoryItemStorage {
  id                String          @id @default(cuid())
  locationId        String
  location          Location        @relation(fields: [locationId], references: [id])
  inventoryItemId   String
  inventoryItem     InventoryItem   @relation(fields: [inventoryItemId], references: [id])
  storageLocationId String
  storageLocation   StorageLocation @relation(fields: [storageLocationId], references: [id])

  currentStock      Decimal  @default(0)  // Stock at THIS location
  parLevel          Decimal? // Par level for THIS location

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([inventoryItemId, storageLocationId])
  @@index([locationId])
  @@index([storageLocationId])
  @@index([inventoryItemId])
}

// Prep items - made from inventory items
model PrepItem {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  name        String   // "Shredded Chicken", "Simple Syrup"
  description String?

  // Output specifications
  outputUnit    String   // "oz", "each", "qt"
  batchYield    Decimal  // How much one batch makes
  batchUnit     String   // Unit for batch (may differ from output)
  costPerUnit   Decimal? // Auto-calculated from ingredients

  // Shelf life
  shelfLifeHours Int?
  storageNotes   String?

  // Daily Prep Count configuration
  isDailyCountItem  Boolean  @default(false)  // Can this item be counted daily?
  currentPrepStock  Decimal  @default(0)      // Current prepared quantity on hand
  lastCountedAt     DateTime?                 // When was this last counted?

  // Stock alert thresholds
  lowStockThreshold      Decimal?  // Show 🟡 warning when below this
  criticalStockThreshold Decimal?  // Show 🔴 critical when below this
  onlineStockThreshold   Decimal?  // Show "Limited availability" online when below this

  // Relations
  ingredients    PrepItemIngredient[]
  recipeUsages   MenuItemRecipeIngredient[]
  modifierLinks  ModifierInventoryLink[]

  // Ingredients that link to this prep item for deduction
  ingredientLinks  Ingredient[]   @relation("IngredientPrepLink")

  isActive  Boolean  @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, name])
  @@index([locationId])
}

// What goes into a prep item
model PrepItemIngredient {
  id              String        @id @default(cuid())
  locationId      String
  location        Location      @relation(fields: [locationId], references: [id])
  prepItemId      String
  prepItem        PrepItem      @relation(fields: [prepItemId], references: [id], onDelete: Cascade)
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  quantity        Decimal       // Amount used
  unit            String        // Unit (should match inventory storageUnit)

  sortOrder       Int           @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([prepItemId, inventoryItemId])
  @@index([locationId])
}

// Recipe - links menu items to ingredients
model MenuItemRecipe {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  menuItemId  String   @unique
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  // Calculated costs
  totalCost     Decimal?  // Sum of all ingredients
  foodCostPct   Decimal?  // totalCost / menuItem.price

  // Relations
  ingredients   MenuItemRecipeIngredient[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([menuItemId])
}

// Individual ingredient in a recipe
model MenuItemRecipeIngredient {
  id          String          @id @default(cuid())
  locationId  String
  location    Location        @relation(fields: [locationId], references: [id])
  recipeId    String
  recipe      MenuItemRecipe  @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  // Link to either inventory item OR prep item (one must be set)
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])
  prepItemId      String?
  prepItem        PrepItem?      @relation(fields: [prepItemId], references: [id])

  quantity    Decimal  // Amount used
  unit        String   // Unit
  cost        Decimal? // Calculated cost for this ingredient

  sortOrder   Int      @default(0)
  notes       String?  // "lightly toasted", "diced"

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([recipeId])
  @@index([inventoryItemId])
  @@index([prepItemId])
}

// Links modifiers to inventory for tracking
model ModifierInventoryLink {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  modifierId  String   @unique
  modifier    Modifier @relation(fields: [modifierId], references: [id], onDelete: Cascade)

  // Link to either inventory item OR prep item
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])
  prepItemId      String?
  prepItem        PrepItem?      @relation(fields: [prepItemId], references: [id])

  // Usage amount when modifier is selected
  usageQuantity   Decimal
  usageUnit       String
  calculatedCost  Decimal?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([inventoryItemId])
  @@index([prepItemId])
}

// Inventory count session
model InventoryCount {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  countDate   DateTime @default(now())
  countType   String   // "full", "area", "spot", "cycle"
  status      String   @default("in_progress") // "in_progress", "completed", "reviewed"

  // Link to storage location (for area counts)
  storageLocationId String?
  storageLocation   StorageLocation? @relation(fields: [storageLocationId], references: [id])

  // Who did it
  startedById   String?
  completedById String?
  reviewedById  String?

  // Totals
  expectedValue Decimal?
  countedValue  Decimal?
  varianceValue Decimal?
  variancePct   Decimal?

  notes       String?

  // Relations
  items       InventoryCountItem[]

  completedAt DateTime?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  syncedAt    DateTime?

  @@index([locationId])
  @@index([storageLocationId])
  @@index([countDate])
  @@index([status])
}

// Individual item in a count
model InventoryCountItem {
  id               String          @id @default(cuid())
  locationId       String
  location         Location        @relation(fields: [locationId], references: [id])
  inventoryCountId String
  inventoryCount   InventoryCount  @relation(fields: [inventoryCountId], references: [id], onDelete: Cascade)
  inventoryItemId  String
  inventoryItem    InventoryItem   @relation(fields: [inventoryItemId], references: [id])

  expectedQty      Decimal   // What system says
  countedQty       Decimal?  // What was counted
  variance         Decimal?  // countedQty - expectedQty
  varianceValue    Decimal?  // variance * costPerUnit
  variancePct      Decimal?

  countedAt        DateTime?
  notes            String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([inventoryCountId])
}

// Inventory transactions for InventoryItems (purchases, adjustments, transfers)
model InventoryItemTransaction {
  id              String        @id @default(cuid())
  locationId      String
  location        Location      @relation(fields: [locationId], references: [id])
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  // Transaction type
  type            String   // "purchase", "sale", "adjustment", "waste", "transfer", "count"

  // Quantities
  quantityBefore  Decimal
  quantityChange  Decimal  // Positive for additions, negative for deductions
  quantityAfter   Decimal

  // Cost info
  unitCost        Decimal?
  totalCost       Decimal?

  // Reference info
  reason          String?
  referenceType   String?  // "invoice", "order", "waste_log", "count"
  referenceId     String?  // ID of related record
  notes           String?

  // Who did it
  employeeId      String?

  createdAt DateTime  @default(now())
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([inventoryItemId])
  @@index([type])
  @@index([createdAt])
  @@index([inventoryItemId, createdAt])
}

// Vendor management
model Vendor {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  name        String
  accountNum  String?
  phone       String?
  email       String?
  address     String?
  notes       String?

  // Payment terms
  paymentTerms String?  // "Net 30", "COD"

  isActive    Boolean  @default(true)

  // Relations
  invoices    Invoice[]
  defaultForItems InventoryItem[] @relation("DefaultVendor")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, name])
  @@index([locationId])
}

// Invoice/Purchase tracking
model Invoice {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id])

  invoiceNumber String
  invoiceDate   DateTime
  dueDate       DateTime?
  receivedDate  DateTime?

  // Totals
  subtotal      Decimal
  taxAmount     Decimal  @default(0)
  shippingCost  Decimal  @default(0)
  totalAmount   Decimal

  // Status
  status        String   @default("pending") // "pending", "received", "paid"
  paidDate      DateTime?

  // Options
  updateCosts     Boolean @default(true)  // Update item costs from invoice
  addToInventory  Boolean @default(true)  // Add quantities to inventory

  notes         String?

  // Relations
  lineItems     InvoiceLineItem[]

  // Who entered it
  enteredById   String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([vendorId])
  @@index([invoiceDate])
  @@index([status])
}

// Invoice line items
model InvoiceLineItem {
  id              String        @id @default(cuid())
  locationId      String
  location        Location      @relation(fields: [locationId], references: [id])
  invoiceId       String
  invoice         Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  // If not linked to inventory item
  description     String?

  quantity        Decimal
  unit            String
  unitCost        Decimal
  totalCost       Decimal

  // For cost comparison
  previousCost    Decimal?  // What it cost before
  costChange      Decimal?  // Difference
  costChangePct   Decimal?  // % change

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([invoiceId])
  @@index([inventoryItemId])
}

// Waste log for non-void waste
model WasteLogEntry {
  id              String        @id @default(cuid())
  locationId      String
  location        Location      @relation(fields: [locationId], references: [id])
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  quantity        Decimal
  unit            String
  costImpact      Decimal?

  reason          String   // "spoilage", "spill", "overcooked", "contamination", "training"
  notes           String?

  // Who logged it
  employeeId      String?

  wasteDate       DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  syncedAt        DateTime?

  @@index([locationId])
  @@index([wasteDate])
  @@index([reason])
  @@index([inventoryItemId])
}

// Settings for inventory management
model InventorySettings {
  id          String   @id @default(cuid())
  locationId  String   @unique
  location    Location @relation(fields: [locationId], references: [id])

  // Tracking mode: determines what features are enabled
  // - "usage_only": Track what goes out (sales, waste) - no incoming inventory logging required
  // - "full_tracking": Track incoming + outgoing = variance reports, theoretical vs actual
  trackingMode          String  @default("usage_only") // "usage_only", "full_tracking"

  // When to deduct inventory
  // - "on_send": Deduct when order sent to kitchen (committed to making it)
  // - "on_pay": Deduct when order is paid (legacy behavior)
  deductionTiming       String  @default("on_send") // "on_send", "on_pay"

  // Prep stock settings
  trackPrepStock        Boolean @default(true) // Track prep item stock levels
  deductPrepOnSend      Boolean @default(true) // Deduct prep stock when sent to kitchen
  restorePrepOnVoid     Boolean @default(true) // Restore prep stock when voided (if not made)

  // Count settings
  defaultCountFrequency String  @default("weekly") // "daily", "weekly", "biweekly", "monthly"
  countReminderDay      String? // "sunday", "monday"
  countReminderTime     String? // "06:00"
  requireManagerReview  Boolean @default(true)
  varianceAlertPct      Decimal @default(5) // Alert if >5% variance

  // Cost settings
  costChangeAlertPct    Decimal @default(10) // Alert if cost changes >10%
  targetFoodCostPct     Decimal? // Target food cost %
  targetLiquorCostPct   Decimal? // Target liquor cost %

  // Modifier instruction multipliers (for Lite, Extra, etc.)
  multiplierLite        Decimal @default(0.5)  // "Lite" = 50% of standard amount
  multiplierExtra       Decimal @default(2.0)  // "Extra" = 200% of standard amount
  multiplierTriple      Decimal @default(3.0)  // "Triple" = 300% of standard amount

  // Default pour sizes (for liquor)
  defaultPourSizeOz     Decimal @default(1.5)

  // Integration settings
  exportEnabled         Boolean @default(false)
  exportTarget          String? // "marginedge", "restaurant365"
  exportApiKey          String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?
}

// ============================================
// EMPLOYEE BREAKS (Skill 48)
// ============================================

model Break {
  id               String   @id @default(cuid())
  locationId       String
  location         Location @relation(fields: [locationId], references: [id])
  timeClockEntryId String
  employeeId       String

  breakType String    @default("unpaid") // paid, unpaid, meal
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int? // Minutes, calculated on end

  // Status
  status String @default("active") // active, completed

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([timeClockEntryId])
  @@index([employeeId])
  @@index([startedAt])
}

// ============================================
// LIQUOR BUILDER (Skill: Liquor)
// Spirit selection, recipes, pour cost tracking
// ============================================

// Spirit categories: Tequila, Vodka, Gin, Rum, Whiskey, etc.
model SpiritCategory {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Tequila", "Vodka", "Gin"
  displayName String?
  description String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  bottleProducts       BottleProduct[]
  spiritModifierGroups SpiritModifierGroup[]
  inventoryItems       InventoryItem[]      @relation("InventoryItemSpirit")

  @@unique([locationId, name])
  @@index([locationId])
  @@index([sortOrder])
}

// Bottle/Product Library - the actual bottles you buy
model BottleProduct {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Identity
  name        String // "Seagram's 7"
  brand       String? // "Seagram's"
  displayName String? // "Seagram's 7 - WELL"

  // Classification
  spiritCategoryId String
  spiritCategory   SpiritCategory @relation(fields: [spiritCategoryId], references: [id])
  tier             String // 'well', 'call', 'premium', 'top_shelf'

  // Bottle specs
  bottleSizeMl Int // 1750, 750, 1000
  bottleSizeOz Decimal? // Auto-calculated from mL
  unitCost     Decimal // Cost per bottle ($25.99)

  // Pour calculation (uses location default or override)
  pourSizeOz     Decimal? // Override location default
  poursPerBottle Int? // Auto-calculated: bottleSizeMl / pourSizeMl
  pourCost       Decimal? // Auto-calculated: unitCost / poursPerBottle

  // Inventory - tracks bottles on hand
  currentStock  Int     @default(0) // Number of bottles in inventory
  lowStockAlert Int? // Alert when below this many bottles
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  spiritModifiers   Modifier[] // Modifiers that link to this bottle
  recipeIngredients RecipeIngredient[] // Recipes that use this bottle
  linkedMenuItems   MenuItem[] @relation("LinkedBottleMenuItems") // Menu items created from this bottle

  // Link to unified inventory for stock tracking
  inventoryItemId String?        @unique
  inventoryItem   InventoryItem? @relation("BottleInventoryLink", fields: [inventoryItemId], references: [id])

  @@unique([locationId, name])
  @@index([locationId])
  @@index([spiritCategoryId])
  @@index([tier])
}

// Recipe ingredients - what goes into a cocktail
model RecipeIngredient {
  id              String        @id @default(cuid())
  locationId      String
  location        Location      @relation(fields: [locationId], references: [id])
  menuItemId      String
  menuItem        MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  bottleProductId String
  bottleProduct   BottleProduct @relation(fields: [bottleProductId], references: [id])

  // Pour amount
  pourCount       Decimal  @default(1) // 1 pour, 0.5 pour, 2 pours
  pourSizeOz      Decimal? // Override location default
  isRequired      Boolean  @default(true)
  isSubstitutable Boolean  @default(true) // Can swap for different tier (premium upgrade)

  // For display
  sortOrder Int     @default(0)
  notes     String? // "Top with...", "Float", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([menuItemId, bottleProductId])
  @@index([locationId])
  @@index([menuItemId])
  @@index([bottleProductId])
}

// Links ModifierGroup to SpiritCategory for spirit selection
model SpiritModifierGroup {
  id               String         @id @default(cuid())
  locationId       String
  location         Location       @relation(fields: [locationId], references: [id])
  modifierGroupId  String         @unique
  modifierGroup    ModifierGroup  @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  spiritCategoryId String
  spiritCategory   SpiritCategory @relation(fields: [spiritCategoryId], references: [id])

  // Upsell configuration
  upsellEnabled    Boolean @default(true)
  upsellPromptText String? // "Upgrade to {name} for ${diff}?"
  defaultTier      String  @default("well") // Default selection tier

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([spiritCategoryId])
}

// Track spirit upsell performance for reporting
model SpiritUpsellEvent {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  orderId     String
  orderItemId String
  employeeId  String

  // What was the default (well) option
  baseModifierId String // Well spirit modifier ID
  baseTier       String // 'well'
  baseBottleName String // "House Tequila"

  // What was offered as upsell
  upsellModifierId String // Premium spirit modifier ID
  upsellTier       String // 'premium', 'top_shelf', etc.
  upsellBottleName String // "Patron Silver"
  priceDifference  Decimal

  // Outcome
  wasShown    Boolean @default(true)
  wasAccepted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([orderId])
  @@index([employeeId])
  @@index([createdAt])
  @@index([wasAccepted])
}

// ============================================
// MENU ITEM INGREDIENTS (Skill: Ingredients)
// Tracks what's in each menu item with modification options
// ============================================

// Admin-configurable ingredient categories
model IngredientCategory {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  // Identity - code is IMMUTABLE after creation (for historical tracking)
  code        Int      // Auto-assigned sequential number, NEVER changes
  name        String   // "Produce", "Protein" - can be renamed
  description String?

  // Display
  icon        String?  // Emoji or icon name: "🥬", "🍖"
  color       String?  // Hex color for UI grouping
  sortOrder   Int      @default(0)

  // Status
  isActive          Boolean  @default(true)
  needsVerification Boolean  @default(false)

  // Relations
  ingredients Ingredient[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  syncedAt    DateTime?

  @@unique([locationId, code])  // Code unique per location
  @@unique([locationId, name])  // Name unique per location
  @@index([locationId])
}

// Group of swappable ingredients (e.g., "Proteins", "Cheese Options")
model IngredientSwapGroup {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  name        String   // "Proteins", "Cheese Options", "Bread Choices"
  description String?

  // Members of this swap group
  ingredients Ingredient[]

  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  syncedAt    DateTime?

  @@unique([locationId, name])
  @@index([locationId])
}

// Global ingredient library - reusable across menu items
model Ingredient {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  // Identity
  name        String   // "Lettuce", "Bacon", "Ranch"
  description String?  // Optional description

  // Legacy category string - deprecated, use categoryId instead
  category   String? // "produce", "protein", "dairy" - kept for backwards compatibility

  // New Category relation (optional for backwards compatibility, required in UI)
  categoryId       String?
  categoryRelation IngredientCategory? @relation(fields: [categoryId], references: [id])

  // Inventory Link (for deduction tracking)
  // Links to InventoryItem OR PrepItem - one must be set for inventory tracking
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation("IngredientInventoryLink", fields: [inventoryItemId], references: [id])
  prepItemId      String?
  prepItem        PrepItem?      @relation("IngredientPrepLink", fields: [prepItemId], references: [id])

  // Standard portion (used in recipes and for deduction)
  standardQuantity Decimal?  // e.g., 1.5
  standardUnit     String?   // "oz", "slice", "each", "g"

  // Source type: How is this item obtained?
  sourceType       String    @default("delivered")  // "delivered" = purchased from vendor, "made" = made from recipe

  // Purchase info (for delivered items)
  purchaseUnit     String?   // What you order: "case", "bag", "bottle", "gallon", "box", "jar", "each"
  purchaseCost     Decimal?  // Cost per purchase unit (e.g., $45 per case)
  unitsPerPurchase Decimal?  // How many storage units per purchase (e.g., 120 slices per case)
  // Note: standardUnit is the storage/usage unit (slices, lb, oz, etc.)
  // costPerUnit is calculated: purchaseCost / unitsPerPurchase

  // Order Customization Options
  allowNo         Boolean @default(true)   // Customer can say "No X"
  allowLite       Boolean @default(true)   // Customer can say "Lite X"
  allowExtra      Boolean @default(true)   // Customer can say "Extra X"
  allowOnSide     Boolean @default(false)  // Customer can say "X on side"

  // Pricing for customizations
  extraPrice      Decimal @default(0)      // Upcharge for "Extra"

  // Inventory multipliers for customizations
  liteMultiplier  Decimal @default(0.5)    // Lite = 50% of standard
  extraMultiplier Decimal @default(2.0)    // Extra = 200% of standard

  // Swap configuration
  allowSwap           Boolean              @default(false)
  swapGroupId         String?              // Links to a group of swappable ingredients
  swapGroup           IngredientSwapGroup? @relation(fields: [swapGroupId], references: [id])
  swapUpcharge        Decimal              @default(0)

  // Visibility (for future use)
  // "visible" = staff sees in counts/POS
  // "admin_only" = only managers see (for cost tracking)
  // "hidden" = system internal, deprecated items
  visibility      String  @default("visible")  // "visible", "admin_only", "hidden"

  // Display
  sortOrder       Int     @default(0)
  isActive        Boolean @default(true)

  // Menu Item links (which items use this ingredient)
  menuItemIngredients MenuItemIngredient[]

  // Modifiers that deduct from this ingredient
  linkedModifiers     Modifier[] @relation("ModifierIngredient")

  // ========== INGREDIENT HIERARCHY (Parent/Child Preparations) ==========
  // Allows tracking preparations like: Raw Chicken → Sliced Chicken, Diced Chicken
  // Child ingredient cost = Parent cost / yieldPercent
  parentIngredientId String?
  parentIngredient   Ingredient?  @relation("IngredientHierarchy", fields: [parentIngredientId], references: [id])
  childIngredients   Ingredient[] @relation("IngredientHierarchy")

  // Preparation info (for child ingredients)
  preparationType    String?   // "Sliced", "Diced", "Cooked", "Marinated", "Ground"
  yieldPercent       Decimal?  // e.g., 0.94 = 94% yield (6% cooking loss)
  batchYield         Decimal?  // How many of this prep item from 1 unit of parent (e.g., 16 slices from 1 lb)

  // ========== EXPLICIT INPUT → OUTPUT (New Model) ==========
  // For prep items: defines the transformation from parent to this item
  // Example: 6 oz Raw Chicken → 2 oz Shredded Chicken

  // INPUT: How much of parent is consumed to make this prep item
  inputQuantity      Decimal?  // e.g., 6 (oz of raw chicken)
  inputUnit          String?   // e.g., "oz" - should match or be convertible to parent's unit

  // OUTPUT: How much of this prep item is produced
  outputQuantity     Decimal?  @default(1)  // e.g., 2 (oz shredded) or 1 (crust)
  outputUnit         String?   @default("each")  // e.g., "oz" for bulk, "each" for discrete items

  // ========== RECIPE BATCH YIELD (For Inventory Items) ==========
  // For inventory items with recipes: defines how much one recipe batch makes
  // Example: "This dough recipe makes 50 lb" or "This sauce recipe makes 1 gallon"
  recipeYieldQuantity Decimal?  // e.g., 50
  recipeYieldUnit     String?   // e.g., "lb", "gallons", "batches"

  // DEPRECATED: Legacy fields - kept for migration, use inputQuantity/outputQuantity instead
  portionSize        Decimal?  // DEPRECATED: Use inputQuantity
  portionUnit        String?   // DEPRECATED: Use inputUnit

  // Daily counting (for prep items counted each morning)
  isDailyCountItem   Boolean @default(false)  // Include in daily prep count
  currentPrepStock   Decimal @default(0)      // Current stock from last count
  lastCountedAt      DateTime?                // When last counted
  countPrecision     String  @default("whole") // 'whole' = integers only (pizzas), 'decimal' = allow decimals (oz, lbs)

  // Stock alert thresholds (for prep items)
  lowStockThreshold      Decimal?  // Show 🟡 warning on POS when below this
  criticalStockThreshold Decimal?  // Show 🔴 critical on POS when below this
  onlineStockThreshold   Decimal?  // Show "Limited availability" online when below this

  // Daily count behavior
  resetDailyToZero       Boolean @default(true)   // true = fresh prep (expect 0), false = carry forward
  varianceHandling       String  @default("auto_adjust")  // 'auto_adjust', 'require_reason', 'auto_waste'
  varianceThreshold      Decimal @default(10)     // % threshold for requiring reason (e.g., 10 = 10%)

  // Is this a base ingredient (root) or a preparation (child)?
  isBaseIngredient   Boolean @default(true)

  // ========== 86 STATUS (Out of Stock) ==========
  // When an ingredient is 86'd, all menu items and modifiers using it become unavailable
  is86d              Boolean   @default(false)   // Currently out of stock
  last86dAt          DateTime?                   // When it was last marked as 86
  last86dBy          String?                     // Employee ID who marked it
  showOnQuick86      Boolean   @default(false)   // Show in Quick 86 custom list at top

  // ========== VERIFICATION (Items created from menu builder) ==========
  // Items created from menu builder need confirmation from inventory team
  needsVerification  Boolean   @default(false)   // Created from menu builder, needs review
  verifiedAt         DateTime?                   // When verified by inventory team
  verifiedBy         String?                     // Employee ID who verified

  // Daily Prep Count relations (for prep-style ingredients)
  trayConfigs              PrepTrayConfig[]             @relation("IngredientTrayConfigs")
  dailyCountItems          DailyPrepCountItem[]         @relation("IngredientDailyCountItems")
  dailyCountTransactions   DailyPrepCountTransaction[]  @relation("IngredientDailyCountTransactions")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  // Recipe components - what raw materials make this inventory item
  recipeComponents   IngredientRecipe[] @relation("RecipeOutput")
  // Where this ingredient is used as a component
  usedInRecipes      IngredientRecipe[] @relation("RecipeComponent")

  // Stock adjustment history
  stockAdjustments IngredientStockAdjustment[]

  // Note: No @@unique on name — soft deletes conflict with DB-level unique constraints.
  // Uniqueness enforced at API level (checks deletedAt: null) to allow re-creation after soft delete.
  @@index([locationId])
  @@index([locationId, name])
  @@index([categoryId])
  @@index([parentIngredientId])
}

// ============================================
// INGREDIENT STOCK ADJUSTMENTS (Skill 127)
// ============================================
// Tracks all manual stock adjustments for cost reporting and audit trails
// Created by Quick Stock Adjust page and other manual adjustment workflows
model IngredientStockAdjustment {
  id           String   @id @default(cuid())
  locationId   String
  location     Location @relation(fields: [locationId], references: [id])

  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  // Adjustment type
  type         String   // "manual", "count", "waste", "transfer", "receiving"

  // Quantity tracking
  quantityBefore  Decimal
  quantityChange  Decimal  // Positive for additions, negative for deductions
  quantityAfter   Decimal
  unit            String?  // Unit of measurement

  // Cost tracking (captured at time of adjustment)
  unitCost        Decimal? // Cost per unit at time of adjustment
  totalCostImpact Decimal? // quantityChange * unitCost (for reporting)

  // Who and why
  employeeId   String?
  employee     Employee? @relation(fields: [employeeId], references: [id])
  reason       String?   // "Morning count", "Waste - dropped", "Received delivery", etc.
  notes        String?

  // Reference to source (if from another workflow)
  referenceType String?  // "daily_count", "waste_log", "purchase_order"
  referenceId   String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([ingredientId])
  @@index([employeeId])
  @@index([type])
  @@index([createdAt])
}

// Recipe for making an inventory item from raw materials
// Example: Pizza Dough = 2 lb Flour + 0.5 oz Yeast + 2 oz Oil + 1 lb Water
model IngredientRecipe {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  // The output item (what gets made) - e.g., Pizza Dough
  outputId    String
  output      Ingredient @relation("RecipeOutput", fields: [outputId], references: [id], onDelete: Cascade)

  // The component/raw material used - e.g., Flour
  componentId String
  component   Ingredient @relation("RecipeComponent", fields: [componentId], references: [id])

  // How much of the component is needed
  quantity    Decimal   // e.g., 2
  unit        String    // e.g., "lb"

  // For batch recipes - this makes X units of output
  // If null, assumes recipe makes 1 unit of output
  batchSize   Decimal?
  batchUnit   String?

  sortOrder   Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  syncedAt    DateTime?

  @@unique([outputId, componentId])
  @@index([locationId])
  @@index([outputId])
  @@index([componentId])
}

// Links ingredients to menu items with quantity overrides
model MenuItemIngredient {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  menuItemId  String
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  // Legacy field - kept for backwards compatibility
  isIncluded Boolean @default(true) // Comes on item by default?

  // Override quantity for this specific item (null = use ingredient's standard)
  quantity    Decimal?
  unit        String?

  // Override customization options for this item
  allowNo     Boolean?  // null = use ingredient default
  allowLite   Boolean?
  allowExtra  Boolean?
  allowOnSide Boolean?
  extraPrice  Decimal?  // Override extra price for this item

  // Is this a "base" ingredient or optional add-on?
  isBase      Boolean @default(true)  // Base ingredients show by default

  sortOrder   Int     @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  syncedAt    DateTime?

  @@unique([menuItemId, ingredientId])
  @@index([locationId])
  @@index([menuItemId])
  @@index([locationId, ingredientId])
  @@index([menuItemId, deletedAt])
}

// ============================================
// MODIFIER GROUP TEMPLATES
// Templates for quick creation of item-specific modifier groups
// These are NOT linked - just copied when used
// ============================================

model ModifierGroupTemplate {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Salad Dressings", "Meat Temps", "Burger Add-ons"
  description String?

  // Default settings copied to new groups
  minSelections Int     @default(0)
  maxSelections Int     @default(1)
  isRequired    Boolean @default(false)

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  modifiers ModifierTemplate[]

  @@unique([locationId, name])
  @@index([locationId])
}

model ModifierTemplate {
  id         String                @id @default(cuid())
  templateId String
  template   ModifierGroupTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name  String
  price Decimal @default(0)

  // Pre-modifier options
  allowNo     Boolean @default(true)
  allowLite   Boolean @default(false)
  allowOnSide Boolean @default(false)
  allowExtra  Boolean @default(false)
  extraPrice  Decimal @default(0)

  // Display
  sortOrder Int     @default(0)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
}

// Tracks ingredient modifications on orders for reporting
model OrderItemIngredient {
  id          String    @id @default(cuid())
  locationId  String
  location    Location  @relation(fields: [locationId], references: [id])
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  ingredientId   String
  ingredientName String // Snapshot at time of order

  // Modification type: "standard", "no", "lite", "on_side", "extra", "swap"
  modificationType String  @default("standard")
  priceAdjustment  Decimal @default(0)

  // For swaps - what was it replaced with?
  swappedToModifierId   String?
  swappedToModifierName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([orderItemId])
  @@index([modificationType])
}

// ============================================
// HARDWARE MANAGEMENT (Printers & KDS Screens)
// ============================================

model Printer {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Kitchen Printer", "Bar Printer", "Receipt Printer"
  printerType String // "thermal" | "impact"
  model       String? // "TM-T88VII", "TM-U220"

  // Network configuration
  ipAddress String
  port      Int    @default(9100)

  // Role
  printerRole String  @default("kitchen") // "receipt" | "kitchen" | "bar"
  isDefault   Boolean @default(false) // Default printer for this role

  // Capabilities
  paperWidth  Int     @default(80) // 80mm or 40mm
  supportsCut Boolean @default(true)

  // Status
  isActive   Boolean   @default(true)
  lastPingAt DateTime?
  lastPingOk Boolean   @default(false)

  // Print template settings (JSON object conforming to PrintTemplateSettings)
  printSettings Json?

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  printJobs   PrintJob[]
  printRules  PrintRule[]
  printRoutes PrintRoute[]
  terminals   Terminal[] @relation("TerminalReceiptPrinter") // Terminals using this as receipt printer

  @@unique([locationId, name])  // Same IP can be used multiple times with different names/roles
  @@index([locationId])
  @@index([printerRole])
  @@index([ipAddress])
}

// ============================================
// UNIFIED STATION (Routing Engine)
// Replaces scattered printerIds with tag-based routing
// One model for both PRINTER and KDS destinations
// ============================================

model Station {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Identity
  name        String  // "Pizza Oven", "Main Expo", "Grill KDS", "Bar Printer"
  displayName String? // Optional friendly name for UI
  type        String  // "PRINTER" | "KDS"

  // Network Configuration (for PRINTER type)
  ipAddress String?
  port      Int?    @default(9100)

  // Tag-based routing (the core of pub/sub)
  // Items with matching tags route to this station
  // e.g., ["pizza", "made-to-order"], ["grill"], ["expo"]
  tags   Json    @default("[]")
  isExpo Boolean @default(false) // Receives ALL items regardless of tags

  // Template Configuration
  templateType String @default("STANDARD_KITCHEN")
  // Values: STANDARD_KITCHEN, PIZZA_STATION, EXPO_SUMMARY, ENTERTAINMENT_TICKET, BAR_TICKET

  // Printer-specific settings (only for PRINTER type)
  printerType   String?  // "thermal" | "impact"
  printerModel  String?  // "TM-T88VII", "TM-U220"
  paperWidth    Int?     @default(80) // 80, 58, 40mm
  supportsCut   Boolean  @default(true)
  printSettings Json?    // PrinterSettings JSON object

  // KDS-specific settings (only for KDS type)
  columns      Int?    @default(4)
  fontSize     String? @default("normal") // "small" | "normal" | "large"
  colorScheme  String? @default("dark") // "dark" | "light"
  agingWarning Int?    @default(8) // Minutes until yellow
  lateWarning  Int?    @default(15) // Minutes until red
  playSound    Boolean @default(true)
  flashOnNew   Boolean @default(true)

  // Reference Items - show other items in order that go to different stations
  // Helps line cooks know "this burger is part of a larger order with a pizza"
  showReferenceItems Boolean @default(true)

  // Atomic Print Configuration - per-element print formatting
  // JSON: { headers: { stationName: {...}, orderNumber: {...} }, dividers: {...}, items: {...} }
  atomicPrintConfig Json?

  // Backup/Failover (for PRINTER type)
  backupStationId String?
  backupStation   Station?  @relation("StationBackup", fields: [backupStationId], references: [id])
  backsUpFor      Station[] @relation("StationBackup")
  failoverTimeout Int?      @default(5000) // ms to wait before trying backup

  // Status
  isActive   Boolean   @default(true)
  isDefault  Boolean   @default(false) // Default station for its type
  lastPingAt DateTime?
  lastPingOk Boolean   @default(false)
  sortOrder  Int       @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, name])
  @@index([locationId])
  @@index([type])
  @@index([isExpo])
}

model KDSScreen {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name       String // "Kitchen Main", "Grill Station", "Bar Display"
  slug       String? // URL-friendly identifier: "kitchen-main", "grill-station"
  screenType String @default("kds") // "kds" | "entertainment"

  // Display Settings
  columns     Int    @default(4)
  fontSize    String @default("normal") // "small" | "normal" | "large"
  colorScheme String @default("dark") // "dark" | "light"

  // Timing Thresholds (minutes)
  agingWarning Int @default(8) // Yellow when older than this
  lateWarning  Int @default(15) // Red when older than this

  // Alerts
  playSound  Boolean @default(true)
  flashOnNew Boolean @default(true)

  // Device Pairing & Authentication
  deviceToken          String?   @unique // Secure token assigned after pairing
  pairingCode          String?   // 6-digit temporary pairing code
  pairingCodeExpiresAt DateTime? // When pairing code expires
  isPaired             Boolean   @default(false) // Whether a device is paired

  // Static IP Configuration (for UniFi/private networks)
  staticIp        String?  // Expected static IP address (e.g., "192.168.1.50")
  enforceStaticIp Boolean  @default(false) // Reject requests from wrong IP

  // Device Info (for troubleshooting)
  lastKnownIp String? // Last IP address seen
  deviceInfo  Json?   // User agent, screen size, etc.

  // Status
  isActive   Boolean   @default(true)
  lastSeenAt DateTime?
  isOnline   Boolean   @default(false)

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  stations   KDSScreenStation[]
  printRules PrintRule[]

  @@unique([locationId, name])
  @@unique([locationId, slug])
  @@index([locationId])
  @@index([deviceToken])
}

model KDSScreenStation {
  id          String      @id @default(cuid())
  locationId  String
  location    Location    @relation(fields: [locationId], references: [id])
  kdsScreenId String
  kdsScreen   KDSScreen   @relation(fields: [kdsScreenId], references: [id], onDelete: Cascade)
  stationId   String
  station     PrepStation @relation(fields: [stationId], references: [id], onDelete: Cascade)

  sortOrder Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?


  @@unique([kdsScreenId, stationId])
  @@index([locationId])
  @@index([kdsScreenId])
  @@index([stationId])
}

// ============================================
// TERMINALS (POS Stations / Handhelds)
// Physical devices where employees clock in and enter orders
// ============================================

model Terminal {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Identity
  name     String // "Bar Terminal 1", "Server Station", "Handheld 3"
  category String @default("FIXED_STATION") // "FIXED_STATION" | "HANDHELD"

  // Network Configuration
  staticIp String? // For fixed stations, helps identify device

  // Device Pairing (similar to KDS pairing)
  deviceToken          String?   @unique // Secure token assigned after pairing
  pairingCode          String?   // 6-digit temporary pairing code
  pairingCodeExpiresAt DateTime? // When pairing code expires
  isPaired             Boolean   @default(false)

  // Device Info
  deviceFingerprint String? // Browser/app fingerprint for handhelds
  lastKnownIp       String? // Last IP address seen
  deviceInfo        Json?   // User agent, screen size, model, etc.

  // Local Receipt Printer
  // The physical receipt printer attached to or near this terminal
  receiptPrinterId String?
  receiptPrinter   Printer? @relation("TerminalReceiptPrinter", fields: [receiptPrinterId], references: [id])

  // Role-Based Skip Rules
  // Format: { "bartender": ["bar"], "manager": ["bar", "kitchen"], "chef": ["kitchen"] }
  // When an employee with this role logs in at this terminal,
  // tickets with these printer roles won't print (they see it on KDS instead)
  roleSkipRules Json?

  // Manual Override
  // When true, ignores all skip rules and prints everything
  forceAllPrints Boolean @default(false)

  // Status
  isActive   Boolean   @default(true)
  isOnline   Boolean   @default(false)
  lastSeenAt DateTime?

  // Failover Configuration
  // If this terminal goes offline, redirect tickets to the backup
  backupTerminalId String?
  backupTerminal   Terminal?  @relation("TerminalFailover", fields: [backupTerminalId], references: [id])
  primaryFor       Terminal[] @relation("TerminalFailover")
  failoverEnabled  Boolean    @default(false)
  failoverTimeout  Int        @default(45000) // ms before considered offline

  // Payment Reader Binding (Datacap Direct Integration)
  paymentReaderId       String?
  paymentReader         PaymentReader? @relation("TerminalPaymentReader", fields: [paymentReaderId], references: [id])
  paymentProvider       String         @default("SIMULATED") // "DATACAP_DIRECT" | "SIMULATED"
  backupPaymentReaderId String?
  backupPaymentReader   PaymentReader? @relation("TerminalBackupReader", fields: [backupPaymentReaderId], references: [id])
  readerFailoverTimeout Int            @default(10000) // 10s before trying backup reader

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, name])
  @@index([locationId])
  @@index([category])
  @@index([staticIp])
  @@index([deviceToken])
  @@index([backupTerminalId])
  @@index([paymentReaderId])
}

// Payment Reader - Datacap Direct card reader devices
model PaymentReader {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Identity
  name         String // "Bar Reader", "Lobby Reader", "Mobile Reader 1"
  serialNumber String @unique // Datacap reader serial - key for identity verification
  ipAddress    String @default("127.0.0.1") // Reader IP (for IP-mode readers); USB/BT use 127.0.0.1
  port         Int    @default(8080) // Datacap default port

  // Connection Type — drives which settings/rules apply
  connectionType String @default("IP") // "USB" | "IP" | "BLUETOOTH" | "WIFI"

  // Datacap Configuration
  merchantId        String? // Datacap merchant ID if different per reader
  terminalId        String? // Datacap terminal ID (their concept, not ours)
  lastSequenceNo    String  @default("0010010010") // Track Datacap SequenceNo per device
  deviceType        String  @default("PAX")        // PAX | INGENICO | IDTECH — determines port/protocol
  communicationMode String  @default("local")      // local | cloud | local_with_cloud_fallback | simulated
  cloudUsername     String?                         // Basic Auth username (cloud mode)
  cloudPassword     String?                         // Basic Auth password (cloud mode, encrypted)

  // Verification Settings
  verificationType String @default("SERIAL_HANDSHAKE") // "SERIAL_HANDSHAKE" | "IP_ONLY"

  // Status
  isActive        Boolean   @default(true)
  isOnline        Boolean   @default(false)
  lastSeenAt      DateTime?
  lastErrorAt     DateTime?
  lastError       String?
  firmwareVersion String?

  // Health Metrics
  avgResponseTime Int?     // Average ms for last 10 transactions
  successRate     Decimal? // % successful in last 24 hours

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  terminals Terminal[] @relation("TerminalPaymentReader")
  backupFor Terminal[] @relation("TerminalBackupReader")
  logs      PaymentReaderLog[]

  @@unique([locationId, name])
  @@index([locationId])
  @@index([isActive])
  @@index([isOnline])
  @@index([serialNumber])
  @@index([connectionType])
}

// ─── Reader Health Log ────────────────────────────────────────────────────────
// Per-transaction metrics for trending response time and success rate over time.

model PaymentReaderLog {
  id           String        @id @default(cuid())
  locationId   String
  location     Location      @relation(fields: [locationId], references: [id])
  readerId     String
  reader       PaymentReader @relation(fields: [readerId], references: [id])
  responseTime Int           // milliseconds
  success      Boolean
  errorCode    String?
  tranType     String?       // sale, void, preauth, etc.
  createdAt    DateTime      @default(now())
  syncedAt     DateTime?

  @@index([locationId])
  @@index([readerId])
  @@index([readerId, createdAt])
  @@index([locationId, createdAt])
}

model PrintRule {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name String?

  // Match Level: category < item < modifier (cascade priority)
  // Higher specificity wins: modifier > item > category
  ruleLevel String // "category" | "item" | "modifier"

  // Match Target (one set based on ruleLevel)
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  menuItemId String?
  menuItem   MenuItem? @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierId String?
  modifier   Modifier? @relation(fields: [modifierId], references: [id], onDelete: Cascade)

  // Primary Destinations
  printerId   String?
  printer     Printer?   @relation(fields: [printerId], references: [id], onDelete: SetNull)
  kdsScreenId String?
  kdsScreen   KDSScreen? @relation(fields: [kdsScreenId], references: [id], onDelete: SetNull)

  // Additional Destinations (JSON arrays of IDs)
  additionalPrinterIds Json? // ["printer-id-1", "printer-id-2"]
  additionalKDSIds     Json? // ["kds-id-1", "kds-id-2"]

  // Options
  printCopies Int     @default(1) // Number of copies to print
  isReference Boolean @default(false) // Abbreviated reference ticket
  printOnSend Boolean @default(true) // Print when sent to kitchen
  showOnKDS   Boolean @default(true) // Show on KDS screens

  priority Int     @default(0) // For tie-breaking within same level
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([categoryId])
  @@index([menuItemId])
  @@index([modifierId])
  @@index([ruleLevel])
}

// ============================================
// PRINT ROUTES (Named Print Routing Configuration)
// Configurable routes for directing tickets to specific printers
// with failover support and route-specific settings
// ============================================

model PrintRoute {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name       String              // "Pizza Printer 1", "Bar Printer"
  routeType  String              // "category" | "item_type" | "station" | "custom"
  isActive   Boolean  @default(true)
  priority   Int      @default(0)

  // Routing criteria
  categoryIds    Json?   // Array of category IDs this route handles
  itemTypes      Json?   // Array of item types (food, liquor, etc.)
  stationId      String? // Specific station

  // Target printer
  printerId      String?
  printer        Printer? @relation(fields: [printerId], references: [id])

  // Backup printer for failover
  backupPrinterId String?
  failoverTimeout Int?    @default(5000) // ms before trying backup

  // Settings
  settings    Json?    // RouteSpecificSettings JSON

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  syncedAt   DateTime?

  @@index([locationId])
  @@index([routeType])
  @@index([priority])
}

model PrintJob {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  jobType   String // "kitchen_ticket" | "receipt" | "reference"
  orderId   String?
  printerId String
  printer   Printer  @relation(fields: [printerId], references: [id])

  status       String  @default("pending") // "pending" | "sent" | "failed"
  errorMessage String?
  retryCount   Int     @default(0)

  content String? // ESC/POS buffer for reprint

  createdAt DateTime  @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?
  sentAt    DateTime?

  @@index([locationId])
  @@index([status])
  @@index([printerId])
  @@index([createdAt])
  @@index([locationId, status])
}

// ============================================
// PIZZA BUILDER
// Comprehensive pizza customization system with sectional toppings
// ============================================

model PizzaConfig {
  id         String   @id @default(cuid())
  locationId String   @unique
  location   Location @relation(fields: [locationId], references: [id])

  // Sectional settings
  maxSections     Int     @default(8) // Max sections: 1 (whole), 2 (halves), 4 (quarters), 8 (eighths)
  defaultSections Int     @default(2) // Default view (halves)
  sectionOptions  Json    @default("[1, 2, 4, 8]") // Available section modes

  // Pricing strategy - FRACTIONAL is recommended
  pricingMode String @default("fractional")
  // "fractional" (DEFAULT): coverage% = price% (half = 50%, quarter = 25%, eighth = 12.5%)
  // "flat": any coverage = full topping price (higher margin, simpler)
  // "hybrid": custom percentages per coverage level
  hybridPricing Json? // Only used if pricingMode="hybrid": { "whole": 1.0, "half": 0.6, ... }

  // Free toppings system
  freeToppingsEnabled Boolean @default(false)
  freeToppingsCount   Int     @default(0) // Number of free toppings (0 = none free)
  freeToppingsMode    String  @default("per_pizza") // "per_pizza" | "per_size"
  // per_pizza: same free count regardless of size
  // per_size: different free count per size (configured in PizzaSize)

  // Extra topping charges (after free toppings exhausted)
  extraToppingPrice Decimal? // Override price for toppings after free ones (null = use topping's own price)

  // Display settings
  showVisualBuilder Boolean @default(true) // Toggle for visual pizza graphic
  showToppingList   Boolean @default(true) // Show list view of toppings
  defaultToListView Boolean @default(false) // Start in list view instead of visual

  // Builder mode settings (Skill 109)
  builderMode        String  @default("both") // 'quick' | 'visual' | 'both'
  defaultBuilderMode String  @default("quick") // 'quick' | 'visual' - which opens by default
  allowModeSwitch    Boolean @default(true) // Can servers switch between modes?

  // Printer routing - multiple printers supported
  printerIds Json? // Array of printer IDs: ["printer-id-1", "printer-id-2"]

  // Pizza-specific print settings (JSON object conforming to PizzaPrintSettings)
  printSettings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
}

model PizzaSize {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Small", "Medium", "Large", "XL"
  displayName String? // "10\"", "12\"", "14\"", "18\""
  inches      Int? // Diameter in inches
  slices      Int     @default(8) // Number of slices

  // Pricing
  basePrice         Decimal // Base price for cheese pizza this size
  priceMultiplier   Decimal @default(1.0) // For calculating from base (legacy support)
  toppingMultiplier Decimal @default(1.0) // Topping price multiplier for this size

  // Free toppings per size (when freeToppingsMode = "per_size")
  freeToppings Int @default(0) // Number of free toppings for this size

  // Inventory tracking (Skill 115)
  // Multiplier for ingredient usage - base usage is defined on each component (crust/sauce/cheese/topping)
  // Small=0.75, Medium=1.0, Large=1.3, XL=1.6 (example)
  inventoryMultiplier Decimal @default(1.0)

  sortOrder Int     @default(0)
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  orderItemPizzas OrderItemPizza[]

  @@unique([locationId, name])
  @@index([locationId])
  @@index([sortOrder])
}

model PizzaCrust {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Hand Tossed", "Thin", "Deep Dish", "Stuffed"
  displayName String?
  description String?
  price       Decimal @default(0) // Upcharge for specialty crusts

  // Inventory tracking (Skill 115)
  // Links to dough inventory - usage is for MEDIUM size, scaled by size multiplier
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation("PizzaCrustInventory", fields: [inventoryItemId], references: [id])
  usageQuantity   Decimal?       // Base usage for medium pizza (e.g., 12 oz dough)
  usageUnit       String?        // "oz", "each"

  sortOrder Int     @default(0)
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  pizzaSpecialties PizzaSpecialty[] @relation("DefaultCrust")
  orderItemPizzas  OrderItemPizza[]

  @@unique([locationId, name])
  @@index([locationId])
  @@index([sortOrder])
}

model PizzaSauce {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Marinara", "White", "BBQ", "Buffalo", "No Sauce"
  displayName String?
  description String?
  price       Decimal @default(0)

  // Sauce amount options
  allowLight Boolean @default(true)
  allowExtra Boolean @default(true)
  extraPrice Decimal @default(0)

  // Inventory tracking (Skill 115)
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation("PizzaSauceInventory", fields: [inventoryItemId], references: [id])
  usageQuantity   Decimal?       // Base usage for medium pizza (e.g., 4 oz sauce)
  usageUnit       String?        // "oz"

  sortOrder Int     @default(0)
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  pizzaSpecialties PizzaSpecialty[] @relation("DefaultSauce")
  orderItemPizzas  OrderItemPizza[]

  @@unique([locationId, name])
  @@index([locationId])
  @@index([sortOrder])
}

model PizzaCheese {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Mozzarella", "No Cheese", "Extra Cheese", "Vegan"
  displayName String?
  description String?
  price       Decimal @default(0)

  // Cheese amount options
  allowLight Boolean @default(true)
  allowExtra Boolean @default(true)
  extraPrice Decimal @default(0)

  // Inventory tracking (Skill 115)
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation("PizzaCheeseInventory", fields: [inventoryItemId], references: [id])
  usageQuantity   Decimal?       // Base usage for medium pizza (e.g., 8 oz cheese)
  usageUnit       String?        // "oz"

  sortOrder Int     @default(0)
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  pizzaSpecialties PizzaSpecialty[] @relation("DefaultCheese")
  orderItemPizzas  OrderItemPizza[]

  @@unique([locationId, name])
  @@index([locationId])
  @@index([sortOrder])
}

model PizzaTopping {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  name        String // "Pepperoni", "Mushrooms", "Onions"
  displayName String?
  description String?

  // Category for grouping in UI
  category String @default("standard") // "meat", "veggie", "premium", "cheese", "seafood"

  // Pricing
  price      Decimal // Base price for whole pizza
  extraPrice Decimal? // Price for "extra" (2x amount)

  // Visual (for visual pizza builder)
  color   String? // Hex color for visual builder representation
  iconUrl String? // Optional icon image

  // Inventory tracking (Skill 115)
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation("PizzaToppingInventory", fields: [inventoryItemId], references: [id])
  usageQuantity   Decimal?       // Base usage for medium whole pizza (e.g., 2 oz pepperoni)
  usageUnit       String?        // "oz", "each"

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, name])
  @@index([locationId])
  @@index([category])
  @@index([sortOrder])
}

model PizzaSpecialty {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  menuItemId String   @unique // Links to MenuItem with itemType="pizza"
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  // Default configuration
  defaultCrustId  String?
  defaultCrust    PizzaCrust?  @relation("DefaultCrust", fields: [defaultCrustId], references: [id])
  defaultSauceId  String?
  defaultSauce    PizzaSauce?  @relation("DefaultSauce", fields: [defaultSauceId], references: [id])
  defaultCheeseId String?
  defaultCheese   PizzaCheese? @relation("DefaultCheese", fields: [defaultCheeseId], references: [id])

  sauceAmount  String @default("regular") // "none", "light", "regular", "extra"
  cheeseAmount String @default("regular")

  // Pre-selected toppings (JSON array)
  // [{ "toppingId": "...", "name": "Pepperoni", "sections": [0,1,2,3,4,5,6,7], "amount": "regular" }, ...]
  toppings Json @default("[]")

  // Allow modifications?
  allowSizeChange   Boolean @default(true)
  allowCrustChange  Boolean @default(true)
  allowSauceChange  Boolean @default(true)
  allowCheeseChange Boolean @default(true)
  allowToppingMods  Boolean @default(true) // Add/remove toppings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([menuItemId])
}

// Order item extension for pizza orders - stores the actual pizza configuration
model OrderItemPizza {
  id          String    @id @default(cuid())
  locationId  String
  location    Location  @relation(fields: [locationId], references: [id])
  orderItemId String    @unique
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  // Size selection
  sizeId String
  size   PizzaSize @relation(fields: [sizeId], references: [id])

  // Crust selection
  crustId String
  crust   PizzaCrust @relation(fields: [crustId], references: [id])

  // Sauce selection (optional - "No Sauce" pizzas)
  sauceId     String?
  sauce       PizzaSauce? @relation(fields: [sauceId], references: [id])
  sauceAmount String      @default("regular") // "none", "light", "regular", "extra"

  // Cheese selection (optional - "No Cheese" pizzas)
  cheeseId     String?
  cheese       PizzaCheese? @relation(fields: [cheeseId], references: [id])
  cheeseAmount String       @default("regular") // "none", "light", "regular", "extra"

  // Sectional toppings (JSON) - the heart of the pizza builder
  // {
  //   "toppings": [
  //     { "toppingId": "...", "name": "Pepperoni", "sections": [0,1,2,3,4,5,6,7], "amount": "regular", "price": 2.50 },
  //     { "toppingId": "...", "name": "Mushrooms", "sections": [0,1,2,3], "amount": "regular", "price": 1.25 }
  //   ],
  //   "sectionMode": 2  // How many sections was the pizza divided into (1, 2, 4, or 8)
  // }
  toppingsData Json // Set in application code: { toppings: [], sectionMode: 2 }

  // Cooking instructions
  cookingInstructions String? // "well done", "light bake", etc.
  cutStyle            String? // "normal", "square", "uncut"

  // Pricing snapshot at time of order
  sizePrice     Decimal
  crustPrice    Decimal
  saucePrice    Decimal @default(0)
  cheesePrice   Decimal @default(0)
  toppingsPrice Decimal
  totalPrice    Decimal

  // Free toppings tracking
  freeToppingsUsed Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([orderItemId])
  @@index([sizeId])
}

// ============================================
// PAYROLL SYSTEM
// ============================================

// PayrollPeriod - Defines pay periods (weekly, bi-weekly, etc.)
model PayrollPeriod {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Period details
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // 'weekly' | 'biweekly' | 'semimonthly' | 'monthly'

  // Status tracking
  status    String   @default("open") // 'open' | 'processing' | 'closed' | 'paid'
  closedAt  DateTime?
  closedBy  String? // employeeId of manager who closed
  paidAt    DateTime?

  // Totals (calculated when closed)
  totalRegularHours   Decimal?
  totalOvertimeHours  Decimal?
  totalWages          Decimal?
  totalTips           Decimal?
  totalCommissions    Decimal?
  totalBankedTips     Decimal?
  grandTotal          Decimal?

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  payStubs PayStub[]

  @@unique([locationId, periodStart, periodEnd])
  @@index([locationId])
  @@index([status])
  @@index([periodStart])
}

// PayStub - Individual employee pay stub for a period
model PayStub {
  id              String        @id @default(cuid())
  locationId      String
  location        Location @relation(fields: [locationId], references: [id])
  payrollPeriodId String
  employeeId      String

  payrollPeriod PayrollPeriod @relation(fields: [payrollPeriodId], references: [id])
  employee      Employee      @relation(fields: [employeeId], references: [id])

  // Time worked
  regularHours   Decimal @default(0)
  overtimeHours  Decimal @default(0)
  breakMinutes   Int     @default(0)

  // Wages
  hourlyRate     Decimal @default(0)
  regularPay     Decimal @default(0) // regularHours * hourlyRate
  overtimePay    Decimal @default(0) // overtimeHours * hourlyRate * 1.5

  // Tips
  declaredTips     Decimal @default(0) // Tips declared at shift closeout
  tipSharesGiven   Decimal @default(0) // Tip-outs to other employees
  tipSharesReceived Decimal @default(0) // Tip-outs from other employees
  bankedTipsCollected Decimal @default(0) // Previously banked tips now paid
  netTips          Decimal @default(0) // declared - given + received + banked

  // Commissions
  commissionTotal Decimal @default(0)

  // Gross earnings
  grossPay Decimal @default(0) // wages + tips + commission

  // Tax Deductions
  federalTax        Decimal @default(0)
  stateTax          Decimal @default(0)
  socialSecurityTax Decimal @default(0)
  medicareTax       Decimal @default(0)
  localTax          Decimal @default(0)
  totalDeductions   Decimal @default(0) // All taxes combined
  deductions        Json?   // Additional deductions { other: [] }

  // Net pay
  netPay Decimal @default(0)

  // Check/payment reference
  checkNumber String?

  // Shifts included
  shiftCount    Int @default(0)
  shiftIds      Json? // Array of shift IDs included
  timeEntryIds  Json? // Array of time entry IDs included

  // Payment tracking
  paymentMethod String? // 'check' | 'direct_deposit' | 'cash'
  paymentRef    String? // Check number, transaction ID, etc.
  paidAt        DateTime?

  // Status
  status String @default("pending") // 'pending' | 'approved' | 'paid' | 'void'

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([payrollPeriodId, employeeId])
  @@index([locationId])
  @@index([employeeId])
  @@index([payrollPeriodId])
  @@index([status])
}

// ============================================
// SCHEDULING SYSTEM
// ============================================

// Schedule - Weekly schedule template
model Schedule {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Week this schedule is for
  weekStart DateTime // Monday of the week
  weekEnd   DateTime // Sunday of the week

  // Status
  status      String   @default("draft") // 'draft' | 'published' | 'archived'
  publishedAt DateTime?
  publishedBy String? // employeeId

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  shifts ScheduledShift[]

  @@unique([locationId, weekStart])
  @@index([locationId])
  @@index([weekStart])
  @@index([status])
}

// ScheduledShift - Individual shift assignment
model ScheduledShift {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  scheduleId String
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  // Shift timing
  date      DateTime // Date of the shift
  startTime String   // "09:00" (24h format)
  endTime   String   // "17:00" (24h format)

  // Break scheduling
  breakMinutes Int @default(0)

  // Role/position for this shift (may differ from employee's primary role)
  roleId String?
  role   Role?  @relation(fields: [roleId], references: [id])

  // Section assignment (if applicable)
  sectionId String?

  // Status tracking
  status String @default("scheduled") // 'scheduled' | 'confirmed' | 'no_show' | 'called_off' | 'worked'

  // Actual vs scheduled (filled after shift)
  actualStartTime DateTime?
  actualEndTime   DateTime?
  actualHours     Decimal?

  // Trade/swap tracking
  originalEmployeeId String? // If swapped, who was originally scheduled
  swappedAt          DateTime?
  swapApprovedBy     String? // Manager who approved swap

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  swapRequests ShiftSwapRequest[]

  @@index([locationId])
  @@index([scheduleId])
  @@index([employeeId])
  @@index([date])
  @@index([status])
}

// ShiftSwapRequest - Employee shift swap workflow
model ShiftSwapRequest {
  id                      String           @id @default(cuid())
  locationId              String
  location                Location         @relation(fields: [locationId], references: [id])
  shiftId                 String
  shift                   ScheduledShift   @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  requestedByEmployeeId   String
  requestedByEmployee     Employee         @relation("SwapInitiator", fields: [requestedByEmployeeId], references: [id])
  requestedToEmployeeId   String?
  requestedToEmployee     Employee?        @relation("SwapTarget", fields: [requestedToEmployeeId], references: [id])
  status                  String           @default("pending") // pending | accepted | approved | rejected | cancelled
  respondedAt             DateTime?
  approvedAt              DateTime?
  approvedByEmployeeId    String?
  approvedByEmployee      Employee?        @relation("SwapApprover", fields: [approvedByEmployeeId], references: [id])
  expiresAt               DateTime?
  notes                   String?
  declineReason           String?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  deletedAt               DateTime?
  syncedAt                DateTime?

  @@index([locationId])
  @@index([shiftId])
  @@index([requestedByEmployeeId])
  @@index([requestedToEmployeeId])
  @@index([status])
}

// AvailabilityEntry - Employee availability preferences
model AvailabilityEntry {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  // Recurring availability (weekly pattern)
  dayOfWeek     Int      // 0-6 (Sunday-Saturday)
  availableFrom String?  // "09:00" or null for not available
  availableTo   String?  // "17:00" or null for not available
  isAvailable   Boolean  @default(true)

  // Preference level
  preference String @default("available") // 'preferred' | 'available' | 'if_needed' | 'unavailable'

  // Effective dates (for temporary changes)
  effectiveFrom DateTime?
  effectiveTo   DateTime?

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([employeeId, dayOfWeek, effectiveFrom])
  @@index([locationId])
  @@index([employeeId])
  @@index([dayOfWeek])
}

// ============================================
// PAYROLL SETTINGS & TAX CONFIGURATION
// ============================================

// PayrollSettings - Location-level payroll configuration
model PayrollSettings {
  id         String   @id @default(cuid())
  locationId String   @unique
  location   Location @relation(fields: [locationId], references: [id])

  // Pay Period Configuration
  payPeriodType   String @default("biweekly") // 'weekly' | 'biweekly' | 'semimonthly' | 'monthly'
  payDayOfWeek    Int?   // 0-6 for weekly/biweekly (Friday = 5)
  payDayOfMonth1  Int?   // 1-31 for semimonthly/monthly
  payDayOfMonth2  Int?   // Second pay day for semimonthly

  // Overtime Configuration
  overtimeThresholdDaily  Decimal @default(8)  // Hours per day before OT kicks in
  overtimeThresholdWeekly Decimal @default(40) // Hours per week before OT kicks in
  overtimeMultiplier      Decimal @default(1.5) // 1.5x for time-and-a-half
  doubleTimeThreshold     Decimal? // Hours before double-time (California: 12 hrs/day)
  doubleTimeMultiplier    Decimal @default(2.0)

  // Tax Configuration
  stateTaxState   String? // State code: 'CA', 'TX', 'NY', etc.
  stateTaxRate    Decimal? // Flat rate if applicable
  localTaxEnabled Boolean @default(false)
  localTaxRate    Decimal?
  localTaxName    String? // 'City Tax', 'School District', etc.

  // FICA (Social Security & Medicare)
  socialSecurityRate Decimal @default(6.2)  // Employee portion %
  medicareRate       Decimal @default(1.45) // Employee portion %
  socialSecurityWageBase Decimal @default(168600) // 2024 wage base

  // Minimum Wage
  minimumWage      Decimal @default(7.25) // Federal default
  tippedMinimumWage Decimal @default(2.13) // Tipped employee minimum

  // Break Requirements
  mealBreakThreshold    Int @default(360) // Minutes worked before meal break required (6 hrs)
  mealBreakDuration     Int @default(30)  // Required meal break duration in minutes
  restBreakInterval     Int @default(240) // Minutes between rest breaks (4 hrs)
  restBreakDuration     Int @default(10)  // Rest break duration in minutes
  paidMealBreaks        Boolean @default(false)
  paidRestBreaks        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Sync fields (for cloud sync and soft deletes)
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
}

// ============================================
// DAILY PREP COUNTING
// Morning prep workflow: count trays → calculate total → add to prep stock → reverse-deduct from inventory
// ============================================

// Tray configurations for a prep item (e.g., "Large Dough Tray = 6 balls")
model PrepTrayConfig {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  prepItemId  String   // Actually stores Ingredient ID (prep-style ingredients)
  ingredient  Ingredient @relation("IngredientTrayConfigs", fields: [prepItemId], references: [id], onDelete: Cascade)

  // Identity
  name        String   // "Large Dough Tray", "Small Dough Tray", "Loose"
  capacity    Decimal  // 6 (balls, portions, etc.)
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([prepItemId, name])
  @@index([locationId])
  @@index([prepItemId])
}

// Daily Prep Count session - represents a morning count session
model DailyPrepCount {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  // Session details
  countDate   DateTime @default(now()) // Date of the count (morning of prep day)
  status      String   @default("draft") // "draft", "submitted", "approved", "rejected"

  // Who created, submitted, approved
  createdById String
  createdBy   Employee @relation("PrepCountCreatedBy", fields: [createdById], references: [id])

  submittedById String?
  submittedBy   Employee? @relation("PrepCountSubmittedBy", fields: [submittedById], references: [id])
  submittedAt   DateTime?

  approvedById String?
  approvedBy   Employee? @relation("PrepCountApprovedBy", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  rejectionReason String? // If status = "rejected", why?
  notes           String?

  // Relations
  countItems   DailyPrepCountItem[]
  transactions DailyPrepCountTransaction[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([countDate])
  @@index([status])
  @@index([createdById])
}

// Individual prep item count within a daily count session
model DailyPrepCountItem {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  dailyCountId String
  dailyCount   DailyPrepCount @relation(fields: [dailyCountId], references: [id], onDelete: Cascade)

  prepItemId  String   // Actually stores Ingredient ID (prep-style ingredients)
  ingredient  Ingredient @relation("IngredientDailyCountItems", fields: [prepItemId], references: [id])

  // Tray breakdown - JSON: { "Large Tray": 3, "Small Tray": 2, "Loose": 4 }
  // Keys are tray names, values are quantities counted
  trayBreakdown Json?

  // Calculated values
  totalCounted      Decimal   // Sum of all trays: (Large * 6) + (Small * 12) + loose
  expectedQuantity  Decimal?  // Previous closing stock (for variance)
  variance          Decimal?  // totalCounted - expectedQuantity
  variancePercent   Decimal?  // (variance / expectedQuantity) * 100

  // Cost impact (calculated on approval)
  costPerUnit       Decimal?  // Snapshot of prep item cost
  totalCost         Decimal?  // totalCounted * costPerUnit

  notes String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([dailyCountId, prepItemId])
  @@index([locationId])
  @@index([dailyCountId])
  @@index([prepItemId])
}

// Audit trail for inventory movements from daily prep counts
model DailyPrepCountTransaction {
  id          String   @id @default(cuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  dailyCountId String
  dailyCount   DailyPrepCount @relation(fields: [dailyCountId], references: [id], onDelete: Cascade)

  // Type of transaction: "prep_stock_add" or "ingredient_deduct"
  type        String

  // For prep item stock additions (actually Ingredient ID)
  prepItemId  String?
  ingredient  Ingredient? @relation("IngredientDailyCountTransactions", fields: [prepItemId], references: [id])

  // For raw ingredient deductions
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  // Quantity movement
  quantityBefore  Decimal
  quantityChange  Decimal  // Positive for prep item add, negative for ingredient deduct
  quantityAfter   Decimal
  unit            String?

  // Cost tracking (for reporting)
  unitCost        Decimal?
  totalCost       Decimal?

  createdAt DateTime  @default(now())
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([dailyCountId])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// ORDER CARDS — Multi-Card Tab Support (Datacap)
// ============================================

model OrderCard {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Reader that processed this card
  readerId String

  // Datacap tokens
  recordNo String  // Datacap RecordNo token — needed for capture/increment/void

  // Card info (from chip/tap data)
  cardType       String  // VISA, MASTERCARD, AMEX, DISCOVER, etc.
  cardLast4      String  // Last 4 digits
  cardholderName String? // Name from chip data (auto-fills tab name)

  // Authorization tracking
  authAmount     Decimal // Current total authorized amount
  isDefault      Boolean @default(false) // Default payment card for this tab

  // Status: authorized | declined | captured | voided
  status         String  @default("authorized")

  // Capture details (at tab close)
  capturedAmount Decimal?
  capturedAt     DateTime?
  tipAmount      Decimal?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([orderId])
  @@index([locationId])
  @@index([status])
  @@index([recordNo])
}

// ============================================
// DIGITAL RECEIPTS — Chargeback Defense (Phase 7)
// ============================================

model DigitalReceipt {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  orderId    String   @unique
  paymentId  String

  // Full receipt content (items, amounts, taxes, discounts, etc.)
  receiptData     Json

  // Signature for chargeback defense
  signatureData   String?  // Base64 PNG from reader or POS screen
  signatureSource String?  // "reader" | "pos_screen"

  // Archive lifecycle
  archivedAt      DateTime?  // When moved to cloud archive

  createdAt DateTime  @default(now())
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([locationId, createdAt])
  @@index([paymentId])
}

// ============================================
// CHARGEBACK CASES — Dispute Tracking (Phase 7)
// ============================================

model ChargebackCase {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Auto-matched order/payment (if found)
  orderId    String?
  paymentId  String?

  // Card info for matching
  cardLast4  String
  cardBrand  String?
  amount     Decimal

  // Chargeback details
  chargebackDate   DateTime
  reason           String?
  reasonCode       String?   // Processor reason code (e.g., "10.4" for fraud)
  responseDeadline DateTime?

  // Status: open | responded | won | lost
  status String @default("open")
  notes  String?

  // Response tracking
  respondedAt    DateTime?
  respondedBy    String?   // Employee who responded
  responseNotes  String?
  resolvedAt     DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([cardLast4])
  @@index([status])
  @@index([chargebackDate])
}

// ============================================
// CARD PROFILES — Repeat Customer Recognition (Phase 8)
// ============================================

model CardProfile {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Hashed card identity (privacy-safe — cannot reverse to card number)
  cardholderIdHash String    // SHA-256 of Datacap CardholderID

  // Card info
  cardType       String     // VISA, MASTERCARD, etc.
  cardLast4      String
  cardholderName String?    // From chip data

  // Visit tracking
  visitCount     Int       @default(0)
  firstSeenAt    DateTime  @default(now())
  lastSeenAt     DateTime  @default(now())
  totalSpend     Decimal   @default(0)

  // Link to Customer record (future: merge via phone number)
  customerId     String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@unique([locationId, cardholderIdHash])
  @@index([locationId, cardLast4])
  @@index([locationId])
}

// ============================================
// WALKOUT RETRY — Declined Tab Recovery (Phase 6)
// ============================================

model WalkoutRetry {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  orderId    String
  orderCardId String   // Which OrderCard to retry capture against

  // Amount to capture
  amount     Decimal

  // Retry schedule
  nextRetryAt    DateTime
  retryCount     Int       @default(0)
  maxRetries     Int       @default(10)  // Calculated from settings

  // Status: pending | collected | exhausted | written_off
  status     String  @default("pending")

  // Result tracking
  lastRetryAt    DateTime?
  lastRetryError String?
  collectedAt    DateTime?
  writtenOffAt   DateTime?
  writtenOffBy   String?   // Employee who wrote off

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([status])
  @@index([nextRetryAt])
}

// ============================================
// BOTTLE SERVICE TIERS (Phase 10)
// ============================================

model BottleServiceTier {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Tier details
  name        String   // e.g., "Bronze", "Silver", "Gold", "Platinum"
  description String?  // e.g., "Includes reserved seating for 4"
  color       String   @default("#D4AF37")  // Banner/badge color (default: gold)

  // Financial
  depositAmount     Decimal  // Pre-auth amount (e.g., $500, $1000, $2000)
  minimumSpend      Decimal  // Soft minimum spend requirement
  autoGratuityPercent Decimal? // Override auto-gratuity for this tier (e.g., 20%)

  // Configuration
  sortOrder  Int      @default(0)  // Display order
  isActive   Boolean  @default(true)

  // Back-relations
  reservations Reservation[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([locationId, isActive])
}

// ============================================
// ERROR REPORTING DOMAIN (Domain 16)
// ============================================
// Mission: Catch and diagnose issues before merchants know there's a problem
// Focus: Orders and payments (critical path), plus full system observability
// Architecture: Hybrid storage (critical → DB, detailed → logs), pivot-ready for external tools

model ErrorLog {
  id String @id @default(cuid())

  // Classification
  severity  String // CRITICAL, HIGH, MEDIUM, LOW
  errorType String // PAYMENT, ORDER, API, FRONTEND, DATABASE, NETWORK, BUSINESS_LOGIC, PERFORMANCE
  category  String // For grouping similar errors (e.g., "payment-timeout", "order-creation-failed")

  // Error Details
  message    String
  stackTrace String? // Full stack trace for debugging
  errorCode  String? // Custom error codes (e.g., "PAY_001", "ORD_403")

  // Context (THE KEY TO QUICK DIAGNOSIS)
  locationId String
  location   Location  @relation(fields: [locationId], references: [id])
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])
  path       String // URL path or API route (e.g., "/api/orders/123/pay")
  action     String // Human-readable action (e.g., "Processing payment for Order #1234")
  component  String? // React component name if frontend error

  // Business Context (CRITICAL PATH)
  orderId    String? // Link to order if order-related
  tableId    String? // Link to table if applicable
  paymentId  String? // Link to payment if payment-related
  customerId String? // Link to customer if applicable

  // Technical Context
  userAgent    String? // Browser user agent
  browserInfo  String? // Parsed browser info (JSON)
  requestBody  String? // Sanitized request body (NO sensitive data)
  responseBody String? // API response if applicable
  queryParams  String? // URL query parameters

  // Performance
  responseTime Int? // Milliseconds (for API calls, DB queries, etc.)

  // Resolution Tracking
  status          String    @default("NEW") // NEW, INVESTIGATING, RESOLVED, IGNORED
  groupId         String? // Link to group similar errors together
  occurrenceCount Int       @default(1) // How many times this exact error occurred
  firstOccurred   DateTime  @default(now()) // First time this error happened
  lastOccurred    DateTime  @default(now()) // Most recent occurrence
  resolvedAt      DateTime? // When was this marked resolved
  resolution      String? // How was it fixed
  notes           String? // Developer notes

  // Alerting
  alertSent   Boolean   @default(false) // Has alert been sent for this error
  alertSentAt DateTime? // When was alert sent

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([locationId, severity])
  @@index([severity])
  @@index([errorType])
  @@index([status])
  @@index([groupId])
  @@index([createdAt])
  @@index([employeeId])
  @@index([orderId])
  @@index([category])
}

model PerformanceLog {
  id String @id @default(cuid())

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Operation Details
  operation String // Description (e.g., "API: GET /api/orders", "Database: findMany orders")
  duration  Int // Milliseconds
  threshold Int // Expected max duration (alert if exceeded)

  // Context
  context    String? // Additional context (JSON)
  stackTrace String? // Where was this called from
  path       String? // URL or code path
  employeeId String?

  createdAt DateTime  @default(now())
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([operation])
  @@index([duration])
  @@index([createdAt])
}

model HealthCheck {
  id String @id @default(cuid())

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Check Details
  checkType    String // ORDER_CREATION, PAYMENT_PROCESSING, PRINTER_CONNECTION, DATABASE_QUERY, API_RESPONSE
  status       String // HEALTHY, DEGRADED, DOWN
  responseTime Int? // Milliseconds
  errorMessage String? // If status != HEALTHY

  // Context
  details String? // Additional details (JSON)

  createdAt DateTime  @default(now())
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([checkType])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// FLEET MANAGEMENT (Skill 345)
// ============================================

enum RegistrationTokenStatus {
  PENDING
  USED
  EXPIRED
  REVOKED
}

model ServerRegistrationToken {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  token     String                  @unique
  status    RegistrationTokenStatus @default(PENDING)
  expiresAt DateTime

  usedAt             DateTime?
  usedByFingerprint  String?
  usedByServerNodeId String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  @@index([locationId])
  @@index([locationId, status, expiresAt])
}

// ============================================
// CLOUD EVENT QUEUE (NUC → Cloud retry pipeline)
// ============================================

model CloudEventQueue {
  id          String   @id @default(uuid())
  venueId     String
  eventType   String
  body        Json
  nextRetryAt DateTime @default(now())
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([nextRetryAt])
  @@map("cloud_event_queue")
}

// ============================================
// REFUND LOG (P2-P02 — Refund vs Void)
// Tracks post-settlement refunds back to processor
// ============================================

model RefundLog {
  id              String    @id @default(cuid())
  locationId      String
  location        Location  @relation(fields: [locationId], references: [id])
  orderId         String
  order           Order     @relation(fields: [orderId], references: [id])
  paymentId       String
  payment         Payment   @relation(fields: [paymentId], references: [id])
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])

  refundAmount    Decimal
  originalAmount  Decimal
  refundReason    String
  notes           String?

  // Datacap processor reference
  datacapRecordNo String?
  datacapRefNo    String?

  // Approval chain
  approvedById    String?
  approvedAt      DateTime?

  // Receipt
  receiptPrinted    Boolean  @default(false)
  receiptPrintedAt  DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  syncedAt        DateTime?

  @@index([locationId])
  @@index([orderId])
  @@index([paymentId])
  @@index([employeeId])
  @@index([createdAt])
  @@index([locationId, createdAt])
}

// ============================================
// ITEM-LEVEL DISCOUNTS (P2-D01)
// ============================================

model OrderItemDiscount {
  id             String        @id @default(cuid())
  locationId     String
  location       Location      @relation(fields: [locationId], references: [id])
  orderId        String
  order          Order         @relation(fields: [orderId], references: [id])
  orderItemId    String
  orderItem      OrderItem     @relation(fields: [orderItemId], references: [id])
  discountRuleId String?
  discountRule   DiscountRule? @relation(fields: [discountRuleId], references: [id])
  amount         Decimal
  percent        Decimal?
  appliedById    String?
  reason         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  syncedAt       DateTime?

  @@index([locationId])
  @@index([orderId])
  @@index([orderItemId])
  @@index([locationId, createdAt])
}

// ============================================
// MOBILE DEVICE AUTHENTICATION (P2-E02)
// Session-based auth for bartender/server phones
// ============================================

model RegisteredDevice {
  id                String   @id @default(cuid())
  locationId        String
  location          Location @relation(fields: [locationId], references: [id])
  name              String                     // "Sarah's iPhone"
  deviceType        String   @default("phone") // phone, tablet
  deviceFingerprint String?                    // browser fingerprint (optional)
  registeredById    String                     // employeeId who first registered
  isActive          Boolean  @default(true)
  lastSeenAt        DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?
  syncedAt          DateTime?
  sessions          MobileSession[]

  @@index([locationId])
  @@index([locationId, isActive])
}

model MobileSession {
  id           String           @id @default(cuid())
  locationId   String
  location     Location         @relation(fields: [locationId], references: [id])
  deviceId     String
  device       RegisteredDevice @relation(fields: [deviceId], references: [id])
  employeeId   String
  employee     Employee         @relation(fields: [employeeId], references: [id])
  sessionToken String           @unique
  expiresAt    DateTime
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  revokedAt    DateTime?

  @@index([locationId])
  @@index([sessionToken])
  @@index([employeeId])
}
